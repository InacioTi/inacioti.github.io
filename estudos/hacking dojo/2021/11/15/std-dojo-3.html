<p>Dando continuidade no desafio do <a href="https://becodoexploit.com/HackingDojo/">Hacking Dojo</a>, hoje atacaremos a semana 03.</p>

<p>Esta semana é bem densa e uma das que mais rendeu <code class="language-plaintext highlighter-rouge">aprendizado</code> até o momento. Basicamente vamos criar alguns utilitários em em <code class="language-plaintext highlighter-rouge">Python</code> que provavelmente utilizaremos posteriormente, sejam nos projetos do <code class="language-plaintext highlighter-rouge">Dojo</code>, ou no próprio dia-a-dia.</p>

<p>Sem mais delongas, vamos às tasks.</p>

<h2 id="task-x10">Task \x10</h2>

<center><img src="/img/std/dojo/dojo-31.png" /></center>

<p>O enunciado desta task pode parecer complexo, mas basicamente o que precisamos é utilizar a biblioteca <a href="https://www.paramiko.org/">Paramiko</a> para criarmos dois scripts: um <code class="language-plaintext highlighter-rouge">SSH server</code> e um <code class="language-plaintext highlighter-rouge">SSH client</code>.</p>

<blockquote>
  <p><strong>Paramiko</strong> é uma biblioteca <code class="language-plaintext highlighter-rouge">Python</code> que permite funcionalidades tanto cliente quanto servidor utilizando o protocolo <code class="language-plaintext highlighter-rouge">SSHv2</code>, basicamente com ela, podemos utilizar de funcionalidades SSH sem depender do serviço do sistema operacional, inclusive utilizando criptografia.</p>
</blockquote>

<h3 id="ssh-client">SSH Client</h3>

<p>Partindo do princípio, vamos iniciar o serviço de SSH no Kali.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>systemctl start ssh
</code></pre></div></div>

<p>Agora precisamos criar um script em Python que seja um cliente para o serviço de SSH em uma VM Linux. Esta VM eu criei com o <code class="language-plaintext highlighter-rouge">Debian 11 - Bullseye</code>.</p>

<p>No próprio <a href="https://github.com/paramiko/paramiko">GitHub do Paramiko</a> é possível encontrar alguns exemplos de scripts que podem ser utilizados como base, ou estudos das funcionalidades. Acontece que o exemplo de client existente, não possui a funcionalidade de executar comandos no server, para isso, vamos precisar de algumas implementações.</p>

<p>A biblioteca Paramiko possui a classe <code class="language-plaintext highlighter-rouge">SSHClient()</code> que por sua vez possui a função <code class="language-plaintext highlighter-rouge">invoke_shell()</code>. Esta função nos permite criar um <code class="language-plaintext highlighter-rouge">canal</code> onde os comandos e respostas serão trasnportados. Abase para o script abaixo, foi do próprio GitHub da biblioteca.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">paramiko.py3compat</span> <span class="kn">import</span> <span class="nb">input</span><span class="p">,</span> <span class="n">u</span>
<span class="kn">import</span> <span class="nn">paramiko</span>

<span class="c1"># windows nao tem termios
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">termios</span>
    <span class="kn">import</span> <span class="nn">tty</span>

    <span class="n">has_termios</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">ImportError</span><span class="p">:</span>
    <span class="n">has_termios</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c1"># funcao que chama o shell de acordo com o SO
</span><span class="k">def</span> <span class="nf">interactive_shell</span><span class="p">(</span><span class="n">chan</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">has_termios</span><span class="p">:</span>
        <span class="n">posix_shell</span><span class="p">(</span><span class="n">chan</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">windows_shell</span><span class="p">(</span><span class="n">chan</span><span class="p">)</span>

<span class="c1"># funcao para o shell em Linux
</span><span class="k">def</span> <span class="nf">posix_shell</span><span class="p">(</span><span class="n">chan</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">select</span>

    <span class="n">oldtty</span> <span class="o">=</span> <span class="n">termios</span><span class="p">.</span><span class="n">tcgetattr</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">stdin</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tty</span><span class="p">.</span><span class="n">setraw</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="n">fileno</span><span class="p">())</span>
        <span class="n">tty</span><span class="p">.</span><span class="n">setcbreak</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="n">fileno</span><span class="p">())</span>
        <span class="n">chan</span><span class="p">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">select</span><span class="p">.</span><span class="n">select</span><span class="p">([</span><span class="n">chan</span><span class="p">,</span> <span class="n">sys</span><span class="p">.</span><span class="n">stdin</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="n">chan</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">u</span><span class="p">(</span><span class="n">chan</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"</span><span class="se">\r\n</span><span class="s">*** EOF</span><span class="se">\r\n</span><span class="s">"</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="k">except</span> <span class="n">socket</span><span class="p">.</span><span class="n">timeout</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">if</span> <span class="n">sys</span><span class="p">.</span><span class="n">stdin</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">chan</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="n">termios</span><span class="p">.</span><span class="n">tcsetattr</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">stdin</span><span class="p">,</span> <span class="n">termios</span><span class="p">.</span><span class="n">TCSADRAIN</span><span class="p">,</span> <span class="n">oldtty</span><span class="p">)</span>

<span class="c1"># funcao para o shell Windows
</span><span class="k">def</span> <span class="nf">windows_shell</span><span class="p">(</span><span class="n">chan</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">threading</span>

    <span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">write</span><span class="p">(</span>
        <span class="s">"Line-buffered terminal emulation. Press F6 or ^Z to send EOF.</span><span class="se">\r\n\r\n</span><span class="s">"</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">writeall</span><span class="p">(</span><span class="n">sock</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">sock</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">256</span><span class="p">).</span><span class="n">decode</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"</span><span class="se">\r\n</span><span class="s">*** EOF ***</span><span class="se">\r\n\r\n</span><span class="s">"</span><span class="p">)</span>
                <span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="k">break</span>
            <span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="n">writer</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">writeall</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">chan</span><span class="p">,))</span>
    <span class="n">writer</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">d</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">chan</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">EOFError</span><span class="p">:</span>
        <span class="c1"># user hit ^Z or F6
</span>        <span class="k">pass</span>


<span class="c1"># Configuracoes do client
</span><span class="n">UseGSSAPI</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">paramiko</span><span class="p">.</span><span class="n">GSS_AUTH_AVAILABLE</span>
<span class="p">)</span>  
<span class="n">DoGSSAPIKeyExchange</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">paramiko</span><span class="p">.</span><span class="n">GSS_AUTH_AVAILABLE</span>
<span class="p">)</span>  
<span class="n">port</span> <span class="o">=</span> <span class="mi">22</span>

<span class="c1"># get hostname
</span><span class="n">username</span> <span class="o">=</span> <span class="s">""</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">hostname</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">hostname</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"@"</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">username</span><span class="p">,</span> <span class="n">hostname</span> <span class="o">=</span> <span class="n">hostname</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"@"</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">hostname</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s">"Hostname: "</span><span class="p">)</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"*** Hostname required."</span><span class="p">)</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">if</span> <span class="n">hostname</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">":"</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">hostname</span><span class="p">,</span> <span class="n">portstr</span> <span class="o">=</span> <span class="n">hostname</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">":"</span><span class="p">)</span>
    <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">portstr</span><span class="p">)</span>


<span class="c1"># get username
</span><span class="k">if</span> <span class="n">username</span> <span class="o">==</span> <span class="s">""</span><span class="p">:</span>
    <span class="n">default_username</span> <span class="o">=</span> <span class="n">getpass</span><span class="p">.</span><span class="n">getuser</span><span class="p">()</span>
    <span class="n">username</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s">"Username [%s]: "</span> <span class="o">%</span> <span class="n">default_username</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">username</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">default_username</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">UseGSSAPI</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">DoGSSAPIKeyExchange</span><span class="p">:</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">getpass</span><span class="p">.</span><span class="n">getpass</span><span class="p">(</span><span class="s">"Password for %s@%s: "</span> <span class="o">%</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">hostname</span><span class="p">))</span>


<span class="c1"># Conectando o cliente com o protocolo SSHv2
</span><span class="k">try</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">paramiko</span><span class="p">.</span><span class="n">SSHClient</span><span class="p">()</span>
    <span class="n">client</span><span class="p">.</span><span class="n">load_system_host_keys</span><span class="p">()</span>
    <span class="n">client</span><span class="p">.</span><span class="n">set_missing_host_key_policy</span><span class="p">(</span><span class="n">paramiko</span><span class="p">.</span><span class="n">WarningPolicy</span><span class="p">())</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"*** Conectando..."</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">UseGSSAPI</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">DoGSSAPIKeyExchange</span><span class="p">:</span>
        <span class="n">client</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">client</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span>
                <span class="n">hostname</span><span class="p">,</span>
                <span class="n">port</span><span class="p">,</span>
                <span class="n">username</span><span class="p">,</span>
                <span class="n">gss_auth</span><span class="o">=</span><span class="n">UseGSSAPI</span><span class="p">,</span>
                <span class="n">gss_kex</span><span class="o">=</span><span class="n">DoGSSAPIKeyExchange</span><span class="p">,</span>
                <span class="n">connect_kwargs</span><span class="o">=</span><span class="p">{</span>
                    <span class="s">"banner_timeout"</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
                    <span class="p">},</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># traceback.print_exc()
</span>            <span class="n">password</span> <span class="o">=</span> <span class="n">getpass</span><span class="p">.</span><span class="n">getpass</span><span class="p">(</span>
                <span class="s">"Password for %s@%s: "</span> <span class="o">%</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">hostname</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">client</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>

    <span class="n">chan</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">invoke_shell</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">get_transport</span><span class="p">()))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"*** Here we go!</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
    <span class="n">interactive_shell</span><span class="p">(</span><span class="n">chan</span><span class="p">)</span>
    <span class="n">chan</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">client</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"*** Caught exception: %s: %s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
    <span class="n">traceback</span><span class="p">.</span><span class="n">print_exc</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">client</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p>Ao executarmos o script na máquina Debian, ele nos pede o <code class="language-plaintext highlighter-rouge">hostname</code>, <code class="language-plaintext highlighter-rouge">username</code> e <code class="language-plaintext highlighter-rouge">password</code>:</p>

<center><img src="/img/std/dojo/dojo-32.png" /></center>

<p>Após as credenciais corretas serem inseridas, temos a conexâo realizada com sucesso.</p>

<center><img src="/img/std/dojo/dojo-33.png" /></center>

<p>Temos um client SSH em Python operante em Linux, agora precisamos testá-lo no <code class="language-plaintext highlighter-rouge">Windows</code>.</p>

<center><img src="/img/std/dojo/dojo-34.png" /></center>

<p>O funcionamento foi o mesmo e a resposta foi o shell.</p>

<center><img src="/img/std/dojo/dojo-35.png" /></center>

<h3 id="ssh-server">SSH Server</h3>

<p>Agora precisamos criar um SSH server com o paramiko, com isso feito, temos um serviço completo de SSH sem depender de ferramentas do SO.</p>

<p>Antes de qualquer coisa, pensei em um script que fosse compatível com tanto para Linux quanto para Windows, sou seja, 100% baseado em Python, e não no sistema operacional.</p>

<p>No GitHub do Paramiko, também existe um exemplo de SSH server, porém ele exige alguns <code class="language-plaintext highlighter-rouge">"apêndices"</code> adicionais, além de que também não tem a funcionalidade de <code class="language-plaintext highlighter-rouge">shell</code>. Portanto, partindo deste script como princípio, também precisamos fazer algumas implementações.</p>

<h4 id="analisando-alguns-pontos-chave-do-script">Analisando alguns pontos chave do script</h4>

<p>Primeiramente, o script precisa de uma chave <code class="language-plaintext highlighter-rouge">RSA</code> para rodar, mesmo que a conexão seja feita via <code class="language-plaintext highlighter-rouge">password</code>. Para que não fosse preciso um arquivo adicional, criei uma chavhe e a inseri diretamente no script:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">chave</span> <span class="o">=</span> <span class="s">'''-----BEGIN RSA PRIVATE KEY-----
MIICWgIBAAKBgQDTj1bqB4WmayWNPB+8jVSYpZYk80Ujvj680pOTh2bORBjbIAyz
oWGW+GUjzKxTiiPvVmxFgx5wdsFvF03v34lEVVhMpouqPAYQ15N37K/ir5XY+9m/
d8ufMCkjeXsQkKqFbAlQcnWMCRnOoPHS3I4vi6hmnDDeeYTSRvfLbW0fhwIBIwKB
gBIiOqZYaoqbeD9OS9z2K9KR2atlTxGxOJPXiP4ESqP3NVScWNwyZ3NXHpyrJLa0
EbVtzsQhLn6rF+TzXnOlcipFvjsem3iYzCpuChfGQ6SovTcOjHV9z+hnpXvQ/fon
soVRZY65wKnF7IAoUwTmJS9opqgrN6kRgCd3DASAMd1bAkEA96SBVWFt/fJBNJ9H
tYnBKZGw0VeHOYmVYbvMSstssn8un+pQpUm9vlG/bp7Oxd/m+b9KWEh2xPfv6zqU
avNwHwJBANqzGZa/EpzF4J8pGti7oIAPUIDGMtfIcmqNXVMckrmzQ2vTfqtkEZsA
4rE1IERRyiJQx6EJsz21wJmGV9WJQ5kCQQDwkS0uXqVdFzgHO6S++tjmjYcxwr3g
H0CoFYSgbddOT6miqRskOQF3DZVkJT3kyuBgU2zKygz52ukQZMqxCb1fAkASvuTv
qfpH87Qq5kQhNKdbbwbmd2NxlNabazPijWuphGTdW0VfJdWfklyS2Kr+iqrs/5wV
HhathJt636Eg7oIjAkA8ht3MQ+XSl9yIJIS8gVpbPxSw5OMfw0PjVE7tBdQruiSc
nvuQES5C9BMHjF39LZiGH1iLQy7FgdHyoP+eodI7
-----END RSA PRIVATE KEY-----'''</span>
</code></pre></div></div>

<p>Na classe <code class="language-plaintext highlighter-rouge">Server</code> que é utilizada para iniciar o servidor, é preciso informar um usuário e senha, que no caso escolhi <code class="language-plaintext highlighter-rouge">h41stur:h41stur</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Server</span><span class="p">(</span><span class="n">paramiko</span><span class="p">.</span><span class="n">ServerInterface</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Event</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">check_channel_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">chanid</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">"session"</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">paramiko</span><span class="p">.</span><span class="n">OPEN_SUCCEEDED</span>
        <span class="k">return</span> <span class="n">paramiko</span><span class="p">.</span><span class="n">OPEN_FAILED_ADMINISTRATIVELY_PROHIBITED</span>

    <span class="k">def</span> <span class="nf">check_auth_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">username</span> <span class="o">==</span> <span class="s">"h41stur"</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">password</span> <span class="o">==</span> <span class="s">"h41stur"</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">paramiko</span><span class="p">.</span><span class="n">AUTH_SUCCESSFUL</span>
        <span class="k">return</span> <span class="n">paramiko</span><span class="p">.</span><span class="n">AUTH_FAILED</span>
    
    <span class="k">def</span> <span class="nf">get_allowed_auths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">"password"</span>

    <span class="k">def</span> <span class="nf">check_channel_shell_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">event</span><span class="p">.</span><span class="nb">set</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">check_channel_pty_request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">pixelwidth</span><span class="p">,</span> <span class="n">pixelheight</span><span class="p">,</span> <span class="n">modes</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>
</code></pre></div></div>
<p>A conexão é feita via socket, então as configurações são feitas da forma como já vimos anteriormente:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">try</span><span class="p">:</span>
    <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">sock</span><span class="p">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">sock</span><span class="p">.</span><span class="n">bind</span><span class="p">((</span><span class="s">""</span><span class="p">,</span> <span class="mi">2200</span><span class="p">))</span>
<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"[-] Erro ao abrir conexao: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="n">traceback</span><span class="p">.</span><span class="n">print_exc</span><span class="p">()</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">sock</span><span class="p">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"[+] Ouvindo conexoes ..."</span><span class="p">)</span>
    <span class="n">client</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">sock</span><span class="p">.</span><span class="n">accept</span><span class="p">()</span>
<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"[-] Erro de conexao: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="n">traceback</span><span class="p">.</span><span class="n">print_exc</span><span class="p">()</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Conectado!"</span><span class="p">)</span>
</code></pre></div></div>

<p>Para que os comandos do shell fossem executados de forma normal, precisei criar um <code class="language-plaintext highlighter-rouge">loop</code> utilizando a função <code class="language-plaintext highlighter-rouge">Popen()</code> da biblioteca <code class="language-plaintext highlighter-rouge">subprocess</code>. Também foi preciso criar uma estrutura <code class="language-plaintext highlighter-rouge">try, except</code> para transportar o resultado dos comandos, pois em sistemas operacionais no idioma português, o encode <code class="language-plaintext highlighter-rouge">UTF-8</code> não aceita nossos acentos, portanto o except contem o transporte do resultado em <code class="language-plaintext highlighter-rouge">LATIN-1</code>.</p>

<p>Neste mesmo loop, inseri um <code class="language-plaintext highlighter-rouge">beautify</code> na linha <code class="language-plaintext highlighter-rouge">chan.send(os.getcwd() + "&gt; ")</code>, para o terminal sempre trazer o path atual, além do comando <code class="language-plaintext highlighter-rouge">sair</code> para encerrar a conexão:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">chan</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s">"&gt; "</span><span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">readline</span><span class="p">().</span><span class="n">strip</span><span class="p">(</span><span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s">"sair"</span><span class="p">:</span>
                <span class="n">chan</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">cmd</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s">"cd"</span><span class="p">:</span>
                <span class="n">os</span><span class="p">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">)</span>
                <span class="n">saida</span> <span class="o">=</span> <span class="n">proc</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">read</span><span class="p">()</span> <span class="o">+</span> <span class="n">proc</span><span class="p">.</span><span class="n">stderr</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">saida_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">saida</span><span class="p">,</span> <span class="s">"utf-8"</span><span class="p">).</span><span class="n">split</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">saida_str</span><span class="p">:</span>
                        <span class="n">chan</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">"</span><span class="se">\r\n</span><span class="s">"</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">saida_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">saida</span><span class="p">,</span> <span class="s">"latin_1"</span><span class="p">).</span><span class="n">split</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">saida_str</span><span class="p">:</span>
                        <span class="n">chan</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s">"</span><span class="se">\r\n</span><span class="s">"</span> <span class="o">+</span> <span class="n">i</span><span class="p">))</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">continue</span>


    <span class="n">chan</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<p>O script completo ficou desta forma:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">from</span> <span class="nn">binascii</span> <span class="kn">import</span> <span class="n">hexlify</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">import</span> <span class="nn">paramiko</span>
<span class="kn">from</span> <span class="nn">paramiko.py3compat</span> <span class="kn">import</span> <span class="n">b</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">decodebytes</span>

<span class="n">chave</span> <span class="o">=</span> <span class="s">'''-----BEGIN RSA PRIVATE KEY-----
MIICWgIBAAKBgQDTj1bqB4WmayWNPB+8jVSYpZYk80Ujvj680pOTh2bORBjbIAyz
oWGW+GUjzKxTiiPvVmxFgx5wdsFvF03v34lEVVhMpouqPAYQ15N37K/ir5XY+9m/
d8ufMCkjeXsQkKqFbAlQcnWMCRnOoPHS3I4vi6hmnDDeeYTSRvfLbW0fhwIBIwKB
gBIiOqZYaoqbeD9OS9z2K9KR2atlTxGxOJPXiP4ESqP3NVScWNwyZ3NXHpyrJLa0
EbVtzsQhLn6rF+TzXnOlcipFvjsem3iYzCpuChfGQ6SovTcOjHV9z+hnpXvQ/fon
soVRZY65wKnF7IAoUwTmJS9opqgrN6kRgCd3DASAMd1bAkEA96SBVWFt/fJBNJ9H
tYnBKZGw0VeHOYmVYbvMSstssn8un+pQpUm9vlG/bp7Oxd/m+b9KWEh2xPfv6zqU
avNwHwJBANqzGZa/EpzF4J8pGti7oIAPUIDGMtfIcmqNXVMckrmzQ2vTfqtkEZsA
4rE1IERRyiJQx6EJsz21wJmGV9WJQ5kCQQDwkS0uXqVdFzgHO6S++tjmjYcxwr3g
H0CoFYSgbddOT6miqRskOQF3DZVkJT3kyuBgU2zKygz52ukQZMqxCb1fAkASvuTv
qfpH87Qq5kQhNKdbbwbmd2NxlNabazPijWuphGTdW0VfJdWfklyS2Kr+iqrs/5wV
HhathJt636Eg7oIjAkA8ht3MQ+XSl9yIJIS8gVpbPxSw5OMfw0PjVE7tBdQruiSc
nvuQES5C9BMHjF39LZiGH1iLQy7FgdHyoP+eodI7
-----END RSA PRIVATE KEY-----'''</span>

<span class="n">chave</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">chave</span><span class="p">)</span>
<span class="n">host_key</span> <span class="o">=</span> <span class="n">paramiko</span><span class="p">.</span><span class="n">RSAKey</span><span class="p">.</span><span class="n">from_private_key</span><span class="p">(</span><span class="n">chave</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Server</span><span class="p">(</span><span class="n">paramiko</span><span class="p">.</span><span class="n">ServerInterface</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Event</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">check_channel_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">chanid</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">"session"</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">paramiko</span><span class="p">.</span><span class="n">OPEN_SUCCEEDED</span>
        <span class="k">return</span> <span class="n">paramiko</span><span class="p">.</span><span class="n">OPEN_FAILED_ADMINISTRATIVELY_PROHIBITED</span>

    <span class="k">def</span> <span class="nf">check_auth_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">username</span> <span class="o">==</span> <span class="s">"h41stur"</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">password</span> <span class="o">==</span> <span class="s">"h41stur"</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">paramiko</span><span class="p">.</span><span class="n">AUTH_SUCCESSFUL</span>
        <span class="k">return</span> <span class="n">paramiko</span><span class="p">.</span><span class="n">AUTH_FAILED</span>
    
    <span class="k">def</span> <span class="nf">get_allowed_auths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">"password"</span>

    <span class="k">def</span> <span class="nf">check_channel_shell_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">event</span><span class="p">.</span><span class="nb">set</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">check_channel_pty_request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">pixelwidth</span><span class="p">,</span> <span class="n">pixelheight</span><span class="p">,</span> <span class="n">modes</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>


<span class="n">DoGSSAPIKeyExchange</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c1"># now connect
</span><span class="k">try</span><span class="p">:</span>
    <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">sock</span><span class="p">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">sock</span><span class="p">.</span><span class="n">bind</span><span class="p">((</span><span class="s">""</span><span class="p">,</span> <span class="mi">2200</span><span class="p">))</span>
<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"[-] Erro ao abrir conexao: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="n">traceback</span><span class="p">.</span><span class="n">print_exc</span><span class="p">()</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">sock</span><span class="p">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"[+] Ouvindo conexoes ..."</span><span class="p">)</span>
    <span class="n">client</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">sock</span><span class="p">.</span><span class="n">accept</span><span class="p">()</span>
<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"[-] Erro de conexao: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="n">traceback</span><span class="p">.</span><span class="n">print_exc</span><span class="p">()</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Conectado!"</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">paramiko</span><span class="p">.</span><span class="n">Transport</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">gss_kex</span><span class="o">=</span><span class="n">DoGSSAPIKeyExchange</span><span class="p">)</span>
    <span class="n">t</span><span class="p">.</span><span class="n">set_gss_host</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">getfqdn</span><span class="p">(</span><span class="s">""</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">t</span><span class="p">.</span><span class="n">load_server_moduli</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"(Failed to load moduli -- gex will be unsupported.)"</span><span class="p">)</span>
        <span class="k">raise</span>
    <span class="n">t</span><span class="p">.</span><span class="n">add_server_key</span><span class="p">(</span><span class="n">host_key</span><span class="p">)</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">Server</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">t</span><span class="p">.</span><span class="n">start_server</span><span class="p">(</span><span class="n">server</span><span class="o">=</span><span class="n">server</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">paramiko</span><span class="p">.</span><span class="n">SSHException</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"*** SSH negotiation failed."</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># wait for auth
</span>    <span class="n">chan</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">accept</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">chan</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"*** No channel."</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"[+] Autenticado!"</span><span class="p">)</span>

    <span class="n">server</span><span class="p">.</span><span class="n">event</span><span class="p">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">server</span><span class="p">.</span><span class="n">event</span><span class="p">.</span><span class="n">is_set</span><span class="p">():</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"*** Client never asked for a shell."</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">chan</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">"</span><span class="se">\r\n\r\n</span><span class="s">H41STUR SSH</span><span class="se">\r\n\r\n</span><span class="s">"</span><span class="p">)</span>
    
    <span class="n">f</span> <span class="o">=</span> <span class="n">chan</span><span class="p">.</span><span class="n">makefile</span><span class="p">(</span><span class="s">"rU"</span><span class="p">)</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">chan</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s">"&gt; "</span><span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">readline</span><span class="p">().</span><span class="n">strip</span><span class="p">(</span><span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s">"sair"</span><span class="p">:</span>
                <span class="n">chan</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">cmd</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s">"cd"</span><span class="p">:</span>
                <span class="n">os</span><span class="p">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">)</span>
                <span class="n">saida</span> <span class="o">=</span> <span class="n">proc</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">read</span><span class="p">()</span> <span class="o">+</span> <span class="n">proc</span><span class="p">.</span><span class="n">stderr</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">saida_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">saida</span><span class="p">,</span> <span class="s">"utf-8"</span><span class="p">).</span><span class="n">split</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">saida_str</span><span class="p">:</span>
                        <span class="n">chan</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">"</span><span class="se">\r\n</span><span class="s">"</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">saida_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">saida</span><span class="p">,</span> <span class="s">"latin_1"</span><span class="p">).</span><span class="n">split</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">saida_str</span><span class="p">:</span>
                        <span class="n">chan</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s">"</span><span class="se">\r\n</span><span class="s">"</span> <span class="o">+</span> <span class="n">i</span><span class="p">))</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">continue</span>


    <span class="n">chan</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"*** Caught exception: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">__class__</span><span class="p">)</span> <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="n">traceback</span><span class="p">.</span><span class="n">print_exc</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">t</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="testando-o-ssh-server">Testando o SSH Server</h4>

<p>Ao executar o script na máquina Kali, ele imprime a mensagem informando que está aguardando conexão (mensagem que pode ser retirada para ser mais <code class="language-plaintext highlighter-rouge">stealth</code>):</p>

<center><img src="/img/std/dojo/dojo-36.png" /></center>

<p>Com a própria ferramenta de <code class="language-plaintext highlighter-rouge">SSH</code> na máquina <code class="language-plaintext highlighter-rouge">Debian</code> podemos testar a conexão com as credenciais <code class="language-plaintext highlighter-rouge">h41stur:h41stur</code> configuradas no script:</p>

<center><img src="/img/std/dojo/dojo-37.png" /></center>

<p>Agora também podemos testar o SSH server com nosso script client:</p>

<center><img src="/img/std/dojo/dojo-38.png" /></center>

<p>Tudo funcionando perfeitamente, neste momento precisamos testar nosso script client na VM Windows em nosso SSH server no Kali:</p>

<center><img src="/img/std/dojo/dojo-39.png" /></center>

<p>Até então, quase tudo pronto nesta task, o que precisamos agora é testar nosso SSH server na VM Windows e conectar via SSH do Kali. Isto se torna muito útil, uma vez que o SSH no Windows é um serviço que precisa ser ativado de alguma forma.</p>

<center><img src="/img/std/dojo/dojo-40.png" /></center>

<p>O <code class="language-plaintext highlighter-rouge">handler</code> aparentemente está ouvindo conexões normalmente, vamos testar com o client SSH do Kali:</p>

<center><img src="/img/std/dojo/dojo-41.png" /></center>

<p>Tudo ocorreu perfeitamente, e conseguimos finalizar a task 16 do Dojo.</p>

<h2 id="task-x11">Task \x11</h2>

<center><img src="/img/std/dojo/dojo-42.png" /></center>

<p>Esta task exige um tanto de pesquisa, após algumas leituras para reforçar o conhecimento, fiz um breve resumo sobre o solicitado.</p>

<h3 id="rfc-1918-address-allocation-for-private-internets">RFC 1918 Address Allocation for Private Internets</h3>

<p>De forma geral uma rede privada de internet, é uma rede que utiliza uma determinada quantia de endereços de IP, que são associados entre si em uma rede que não se comunicam com uma rede externa.</p>

<p>Muito utilizado em empresas e até mesmo nos protocolos atuais de internet residencial chamados de redes <code class="language-plaintext highlighter-rouge">LAN</code>. Onde cada dispositivo conectado ä rede, não possui um IP público, mas sim um IP <code class="language-plaintext highlighter-rouge">privado</code> fornecido por um <code class="language-plaintext highlighter-rouge">gateway</code>, mais comummente chamado de <code class="language-plaintext highlighter-rouge">roteador</code>. Esta se torna outra razão pela qual o os IPs privados são importantes, pois a quantidade de IPs públicos é limitada na internet. O protocolo <code class="language-plaintext highlighter-rouge">IPv6</code> foi criado para resolver este problema.</p>

<p>Os roteadores são configurados deforma a descartar qualquer tráfego que utilize um IP privado. Este isolamento permite que a rede privada tenha um nível a mais de segurança, pois impede que um dispositivo externo se conecte diretamente a outro dispositivo que esteja na rede interna com IP privado.</p>

<p>Como as conexões não podem ser feitas entre diferentes redes privadas através da internet, vários gateways podem ter a mesma faixa de IP sem que haja conflitos, na verdade na rede residencial é um excelente exemplo, pois a grande maioria dos roteadores fornacem IPs privados iniciados em <code class="language-plaintext highlighter-rouge">192.168.1.</code> ou <code class="language-plaintext highlighter-rouge">192.168.0.</code>, sem que sua conexão tenha conflito com a rede de outras residências.</p>

<p>Quando um sidpositivo em uma rete privada precisa se comunicar com a rede externa, o <code class="language-plaintext highlighter-rouge">gateway</code> faz esta comunicação, pois ele é o único que possui um IP público utilizando o protocolo <code class="language-plaintext highlighter-rouge">NAT</code> (Network Address Translation).</p>

<p>As redes privadas podem ser divididas em <code class="language-plaintext highlighter-rouge">classes</code> e <code class="language-plaintext highlighter-rouge">faixas</code> que comportam diferentes quantidades de IPs privados, para uma leitura e entendimento mais profundo, recomendo ler <a href="https://datatracker.ietf.org/doc/html/rfc1918">esta documentação</a>.</p>

<h3 id="protocolos-e-serviços-de-rede">Protocolos e serviços de rede</h3>

<p>Os <code class="language-plaintext highlighter-rouge">protocolos</code> são instruções desenvolvidas por algorítmos com a finalidade de executar uma tarefa definida. São utilizados entre dois ou mais dispositivos para se comunicarem de alguma forma. Existe uma infinidade de protocolos existentes que podem oferecer outra infinidade de serviços.</p>

<p>Já os <code class="language-plaintext highlighter-rouge">serviços</code> são funcionalidades oferecidas numa rede pública ou privada que podem utilizar diversos protocolos. Parece complicado, mas fazermos seu uso o tempo todo, como quando acessamos uma página na internet cujo endereço se inicia com <code class="language-plaintext highlighter-rouge">http://</code>, quando o acessamos, estamos fazendo o uso de um serviço de rede que utiliza o protocolo <code class="language-plaintext highlighter-rouge">HTTP</code> ou <code class="language-plaintext highlighter-rouge">Hypertext Transfer Protocol</code>.</p>

<p>Alguns exemplos protocolos e serviços:</p>

<table>
  <thead>
    <tr>
      <th><strong>Sigla</strong></th>
      <th><strong>Nome</strong></th>
      <th><strong>Função</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>HTTP</td>
      <td><em>Hypertext Transfer Protocol</em> ou<br />Protocolo de Transferência de Hipertexto</td>
      <td>Trata de pedidos e respostas entre o<br />cliente e o servidor na internet.</td>
    </tr>
    <tr>
      <td>FTP</td>
      <td><em>File Transfer Protocol</em> ou<br />Protocolo de Transferência de Arquivos</td>
      <td>Transfere documentos hipermídia na<br />internet.</td>
    </tr>
    <tr>
      <td>SMTP</td>
      <td><em>Simple Mail Transfer Protocol</em> ou<br />Protocolo de Transferência de e-mail</td>
      <td>Envia <em>e-mail</em>.</td>
    </tr>
    <tr>
      <td>IMAP</td>
      <td><em>Internet Message Access Protocol</em> ou<br />Protocolo de acesso a mensagem da internet</td>
      <td>Recebe <em>e-mail</em>.</td>
    </tr>
    <tr>
      <td>Telnet</td>
      <td><em>Telnet</em></td>
      <td>Permite a comunicação remota entre<br />computado-res conectados em rede.</td>
    </tr>
    <tr>
      <td>SSH</td>
      <td><em>Secure Shell</em> ou Terminal Seguro</td>
      <td>Permite a comunicação remota entre<br />computado-res conectados em rede,<br />utilizando criptografia</td>
    </tr>
    <tr>
      <td>DHCP</td>
      <td><em>Dynamic Host Configuration Protocol</em> ou<br />Protocolo de configuração dinâmica de estação</td>
      <td>Concede endereços IP e outros<br />parâmetros dina-micamente para estações<br />de trabalho.</td>
    </tr>
    <tr>
      <td>DNS</td>
      <td><em>Domain Name System</em> ou<br />Sistema de Nome de Domínio</td>
      <td>É um sistema de gerenciamento de<br />nomes hierárquico e distribuído;<br />permite acessar outro computador na rede<br />sem ter conhecimento do endereço IP.</td>
    </tr>
  </tbody>
</table>

<p>Para que estes protocolos e serviços possam se comunicar entre dispositivos, eles utilizarm um modelo que é constítuido de outros dois protocolos, o <code class="language-plaintext highlighter-rouge">TCP/IP</code> (<em>Transmission Control Protocol/InternetProtocol</em>).</p>

<p>Para um entendimento um pouco mais profundo sobre o assunto, recomendo ler <a href="https://www.computer-networking.info/1st/html/intro/services-protocols.html">este artigo</a>.</p>

<h2 id="task-x12">Task \x12</h2>

<center><img src="/img/std/dojo/dojo-43.png" /></center>

<p>Esta task tecnicamente é bem simples, precisamos emular em Python, um banner grabbing com a mesma mecânica de quando utilizamos o <code class="language-plaintext highlighter-rouge">netcat</code>. Porém, temos que ter em mente, que dependendo do serviço a ser enumerado, precisamos enviar algum comando para que retorne o banner, como na porta 80, ondeprecisamos enviar alguma requisição para que retorne o banner.</p>

<p>Testando no netcat:</p>

<center><img src="/img/std/dojo/dojo-44.png" /></center>

<p>Como podemos ver, foi preciso enviar o comando <code class="language-plaintext highlighter-rouge">HEAD /</code> para que retornasse o banner.</p>

<p>Com isto em mente, vamos utilizar a biblioteca <code class="language-plaintext highlighter-rouge">socket</code> para fazer as requisições nas portas <code class="language-plaintext highlighter-rouge">80</code>, <code class="language-plaintext highlighter-rouge">22</code>, e <code class="language-plaintext highlighter-rouge">3306</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span>

<span class="n">host</span> <span class="o">=</span> <span class="s">"192.168.1.11"</span>
<span class="n">portas</span> <span class="o">=</span> <span class="p">[</span><span class="mi">22</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">3306</span><span class="p">]</span>

<span class="k">for</span> <span class="n">porta</span> <span class="ow">in</span> <span class="n">portas</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">porta</span> <span class="o">==</span> <span class="mi">80</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
            <span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">porta</span><span class="p">))</span>
            <span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">"HEAD /</span><span class="se">\r\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
            <span class="n">s</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"[+]Banner da porta 80:</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="n">decode</span><span class="p">()</span> <span class="o">+</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="nb">Exception</span><span class="p">)</span>
            <span class="k">continue</span>
    <span class="k">elif</span> <span class="n">porta</span> <span class="o">==</span> <span class="mi">3306</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
            <span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">porta</span><span class="p">))</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
            <span class="n">s</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"[+]Banner da porta 3306:</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="n">decode</span><span class="p">()</span> <span class="o">+</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">"latin_1"</span> <span class="o">+</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">))</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">continue</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
            <span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">porta</span><span class="p">))</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
            <span class="n">s</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"[+]Banner da porta 22:</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="n">decode</span><span class="p">()</span> <span class="o">+</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">continue</span>
</code></pre></div></div>

<p>Ao executar o script, temos os 3 banners:</p>

<center><img src="/img/std/dojo/dojo-45.png" /></center>

<p>O script ainda está bem simplório, porém vamos trabalhá-lo mais nas próximas tasks.</p>

<h2 id="task-x13">Task \x13</h2>

<center><img src="/img/std/dojo/dojo-46.png" /></center>

<p>Esta task se torna bem mais simples que a anterior, uma vez que se trata somente de um <code class="language-plaintext highlighter-rouge">port scan</code> sem um banner grab. Vamos utilizar a <code class="language-plaintext highlighter-rouge">socket</code> novamente, mas ao invés de utilizarmos a função <code class="language-plaintext highlighter-rouge">connect()</code> para nos conectarmos nas portas, vamos utilizar a <code class="language-plaintext highlighter-rouge">connect_ex()</code>.</p>

<p>A diferença entre elas, é que na <code class="language-plaintext highlighter-rouge">connect_ex()</code>, caso a porta esteja inacessível, ele retorno uma mensagem de erro, enquanto que na <code class="language-plaintext highlighter-rouge">connect()</code>, ele espera pela resposta até atingir o <code class="language-plaintext highlighter-rouge">timeout</code>. O script ficou desta forma:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span>

<span class="n">host</span> <span class="o">=</span> <span class="s">"192.168.1.11"</span>

<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">[+] BANNER GRABBER</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">65536</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">connect_ex</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
    <span class="n">s</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">resp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">] OPEN"</span><span class="p">)</span>
</code></pre></div></div>

<p>Ao executarmos o script, temos o seguinte retorno:</p>

<center><img src="/img/std/dojo/dojo-47.png" /></center>

<p>Isto encerra esta task.</p>

<h2 id="task-x14">Task \x14</h2>

<center><img src="/img/std/dojo/dojo-48.png" /></center>

<p>Nesta task vamos criar um <code class="language-plaintext highlighter-rouge">ping</code> no host alvo utilizando a biblioteca <code class="language-plaintext highlighter-rouge">icmplib</code> do Python. É importante ressaltar que este script só funciona se o ICMP não estiver bloqueado na rede.</p>

<p>O script ficou bem simples:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">icmplib</span> <span class="kn">import</span> <span class="n">ping</span>

<span class="n">host</span> <span class="o">=</span> <span class="s">"192.168.1.11"</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">ping</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">resp</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">packets_received</span>

<span class="k">if</span> <span class="n">resp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">[+] Host </span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s"> vivo!"</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">[-] Host {host} morto!"</span><span class="p">)</span>
</code></pre></div></div>

<p>Ao executarmos, temos a resposta:</p>

<center><img src="/img/std/dojo/dojo-49.png" /></center>

<p>Isto encerra esta task.</p>

<h2 id="task-x15">Task \x15</h2>

<center><img src="/img/std/dojo/dojo-50.png" /></center>

<p>A fim de diminuir este artigo, deixo o link para um artigo completo sobre <a href="https://brasilcloud.com.br/duvidas/o-que-e-uma-mascara-de-sub-rede-sub-mask/">máscara de rede</a>.</p>

<h2 id="task-x16">Task \x16</h2>

<center><img src="/img/std/dojo/dojo-51.png" /></center>

<p>Este script é mais informativo, pois serve apenas para consulta. Seguindo o conhecimento adquirido com o artigo citado na task anterior, desenvolvi o seguinte script:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sys</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'''
Modo de uso:
    %s &lt;barramento&gt;
Exemplo:
    %s /9
    '''</span> <span class="o">%</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">()</span>

<span class="n">dic</span> <span class="o">=</span> <span class="p">{</span><span class="s">"/9"</span><span class="p">:</span> <span class="mi">8388606</span><span class="p">,</span> <span class="s">"/10"</span><span class="p">:</span> <span class="mi">4194302</span><span class="p">,</span> <span class="s">"/11"</span><span class="p">:</span> <span class="mi">2097150</span><span class="p">,</span> <span class="s">"/12"</span><span class="p">:</span> <span class="mi">1048574</span><span class="p">,</span> <span class="s">"/13"</span><span class="p">:</span> <span class="mi">524286</span><span class="p">,</span> <span class="s">"/14"</span><span class="p">:</span> <span class="mi">262142</span><span class="p">,</span> <span class="s">"/15"</span><span class="p">:</span> <span class="mi">131070</span><span class="p">,</span> <span class="s">"/16"</span><span class="p">:</span> <span class="mi">65534</span><span class="p">,</span> <span class="s">"/17"</span><span class="p">:</span> <span class="mi">32766</span><span class="p">,</span>
        <span class="s">"/18"</span><span class="p">:</span> <span class="mi">16382</span><span class="p">,</span> <span class="s">"/19"</span><span class="p">:</span> <span class="mi">8190</span><span class="p">,</span> <span class="s">"/20"</span><span class="p">:</span> <span class="mi">4094</span><span class="p">,</span> <span class="s">"/21"</span><span class="p">:</span> <span class="mi">2046</span><span class="p">,</span> <span class="s">"/22"</span><span class="p">:</span> <span class="mi">1022</span><span class="p">,</span> <span class="s">"/23"</span><span class="p">:</span> <span class="mi">510</span><span class="p">,</span> <span class="s">"/24"</span><span class="p">:</span> <span class="mi">254</span><span class="p">,</span> <span class="s">"/25"</span><span class="p">:</span> <span class="mi">126</span><span class="p">,</span> <span class="s">"/26"</span><span class="p">:</span> <span class="mi">62</span><span class="p">,</span> <span class="s">"/27"</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="s">"/28"</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
        <span class="s">"/29"</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s">"/30"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">"/31"</span><span class="p">:</span> <span class="s">"2 (*)"</span><span class="p">}</span>

<span class="n">consulta</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">info</span> <span class="o">=</span> <span class="s">'''
Bits emprestados        Máscara         Prefixo     Subredes (2n)       Hosts (2n-2)
1                       255.128.0.0         /9          2               8388606
2                       255.192.0.0         /10         4               4194302
3                       255.224.0.0         /11         8               2097150
4                       255.240.0.0         /12         16              1048574
5                       255.248.0.0         /13         32              524286
6                       255.252.0.0         /14         64              262142
7                       255.254.0.0         /15         128             131070
8                       255.255.0.0         /16         256             65534
9                       255.255.128.0       /17         512             32766
10                      255.255.192.0       /18         1024            16382
11                      255.255.224.0       /19         2048            8190
12                      255.255.240.0       /20         4096            4094
13                      255.255.248.0       /21         8192            2046
14                      255.255.252.0       /22         16384           1022
15                      255.255.254.0       /23         32768           510
16                      255.255.255.0       /24         65536           254
17                      255.255.255.128     /25         131072          126
18                      255.255.255.192     /26         262144          62
19                      255.255.255.224     /27         524288          30
20                      255.255.255.240     /28         1048576         14
21                      255.255.255.248     /29         2097152         6
22                      255.255.255.252     /30         4194304         2
23                      255.255.255.254     /31         8388608         2 (*)
'''</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">[+] No barramento </span><span class="si">{</span><span class="n">consulta</span><span class="si">}</span><span class="s"> cabem </span><span class="si">{</span><span class="n">dic</span><span class="p">[</span><span class="n">consulta</span><span class="p">]</span><span class="si">}</span><span class="s"> hosts."</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">INFORMATIVO:</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
</code></pre></div></div>

<p>Ao executá-lo com um <code class="language-plaintext highlighter-rouge">barramento</code> específico como argumento, ele retorna a seguinte resposta:</p>

<center><img src="/img/std/dojo/dojo-52.png" /></center>

<p>Isso encerra esta task.</p>

<h2 id="task-x17">Task \x17</h2>

<center><img src="/img/std/dojo/dojo-53.png" /></center>

<p>De forma bem resumida:</p>

<h3 id="função">Função</h3>

<p>Uma função é basicamente um trecho de código que pode ser chamado pelo seu nome. Pode receber argumentos ou parâmetros e podem retornar dados como resposta de sua execução.</p>

<h3 id="método">Método</h3>

<p>Um método é um trecho de código que também pode ser chamado pelo seu nome associado a um objeto. Muito parecido com uma <code class="language-plaintext highlighter-rouge">função</code>, porém com algumas diferenças:</p>

<ul>
  <li>Um método é passado implicitamente no objeto no qual foi chamado.</li>
  <li>É capaz de operar com dados existentes na classe.</li>
</ul>

<h3 id="classe">Classe</h3>

<p>A classe é um conjunto de objetos distintos, porém com as mesmas características e comportamentos. Assim como descrito na semana \x01 do Dojo, um exemplo de classe abstrato ao mundo real seria uma classe <code class="language-plaintext highlighter-rouge">Motocicleta</code> com as propriedades <code class="language-plaintext highlighter-rouge">cor</code>, <code class="language-plaintext highlighter-rouge">modelo</code>, <code class="language-plaintext highlighter-rouge">cilindradas</code>, <code class="language-plaintext highlighter-rouge">torque</code> e os métodos <code class="language-plaintext highlighter-rouge">acelerar</code> e <code class="language-plaintext highlighter-rouge">frear</code> e a classe <code class="language-plaintext highlighter-rouge">Carro</code>, tem as propriedades <code class="language-plaintext highlighter-rouge">cor</code>, <code class="language-plaintext highlighter-rouge">modelo</code>, <code class="language-plaintext highlighter-rouge">cilindradas</code>, <code class="language-plaintext highlighter-rouge">torque</code> e os métodos <code class="language-plaintext highlighter-rouge">acelerar</code> e <code class="language-plaintext highlighter-rouge">frear</code>.</p>

<p>Pode-se descobrir a cor da moto perguntando por <code class="language-plaintext highlighter-rouge">"Motocicleta.cor"</code>, sendo que da mesma forma podemos saber a cor do carro perguntando <code class="language-plaintext highlighter-rouge">"Carro.cor"</code>. Neste exemplo os dois atributos tem o mesmo nome <code class="language-plaintext highlighter-rouge">“cor”</code>, mas cada um tem sua própria classe náo tendo conflito entre si.</p>

<h2 id="task-x18">Task \x18</h2>

<center><img src="/img/std/dojo/dojo-54.png" /></center>

<p>Esta task é uma evolução do script feito na task 20, a diferença é que ao invés de passarmos o IP alvo como parâmetro, vamos ler uma lista com IPs para <code class="language-plaintext highlighter-rouge">pingar</code>.</p>

<p>Minha lista com 10 IPs:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat </span>hosts.txt 
192.168.1.2
192.168.1.3
192.168.1.4
192.168.1.5
192.168.1.6
192.168.1.7
192.168.1.8
192.168.1.9
192.168.1.10
192.168.1.11
</code></pre></div></div>
<p>E o script continuou simples:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">icmplib</span> <span class="kn">import</span> <span class="n">ping</span>

<span class="n">host</span> <span class="o">=</span> <span class="s">"192.168.0.189"</span>

<span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">ping</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">packets_received</span>
    <span class="k">if</span> <span class="n">resp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"[+] Host vivo:"</span><span class="p">,</span> <span class="n">ip</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"hosts.txt"</span><span class="p">,</span> <span class="s">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">h</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">h</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">check</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</code></pre></div></div>
<p>Ao executarmos o script, temos o seguinte retorno:</p>

<center><img src="/img/std/dojo/dojo-56.png" /></center>

<h2 id="task-x18-de-novo">Task \x18 (de novo)</h2>

<center><img src="/img/std/dojo/dojo-57.png" /></center>

<p>Temos duas tasks 24, talvez algum erro de digitação <code class="language-plaintext highlighter-rouge">(ou proposital??)</code>, então vamos atacá-la.</p>

<p>Antes de começar, precisamos entender que o SO possui várias <code class="language-plaintext highlighter-rouge">interfaces</code> de trabalho, e antes de conseguirmos obter o IP e a máscara de rede, precisamos saber qual a interface correta a ser analisada.</p>

<p>Nesta task, tive que pesquisar alguma biblioteca ou função que conseguisse me retornar as informações que preciso. Acabei me deparando com a biblioteca <a href="https://pypi.org/project/netifaces/">netifaces</a>.</p>

<p>Esta lib consegue listar todas as interfaces do dispositivo, e extrair algumas informações. Porém ainda precisava encontrar o IP correspondente à interface correta.</p>

<p>Para isso, utilizei a biblioteca <code class="language-plaintext highlighter-rouge">socket</code> para fazer uma requisição no IP do <code class="language-plaintext highlighter-rouge">Google: 8.8.8.8</code>, em seguida utilizei a função <code class="language-plaintext highlighter-rouge">getsockname()</code> para obter a resposta da requisição.</p>

<p>Esta função retorna o socket (IP:porta) utilizados na requisição, pegando o primeiro elemento da função, temos o IP para comparar com as informaçoes obtidas com <code class="language-plaintext highlighter-rouge">netifaces</code>.</p>

<p>O script ficou desta forma:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">netifaces</span>
<span class="kn">import</span> <span class="nn">socket</span>

<span class="k">def</span> <span class="nf">self_ip</span><span class="p">():</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
    <span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="s">"8.8.8.8"</span><span class="p">,</span> <span class="mi">80</span><span class="p">))</span>
    <span class="n">ip</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">s</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ip</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">netifaces</span><span class="p">.</span><span class="n">interfaces</span><span class="p">():</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">netifaces</span><span class="p">.</span><span class="n">ifaddresses</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rede</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="n">rede</span><span class="p">[</span><span class="s">"addr"</span><span class="p">]</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">rede</span><span class="p">[</span><span class="s">"netmask"</span><span class="p">]</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="n">self_ip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">addr</span> <span class="o">==</span> <span class="n">ip</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">[+] A interface e:"</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">[+] IP:"</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"[+] Netmask:"</span><span class="p">,</span> <span class="n">mask</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"*"</span> <span class="o">*</span> <span class="mi">50</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">continue</span>
</code></pre></div></div>
<p>Ao executar o script na VM Windows, temos o seguinte retorno:</p>

<center><img src="/img/std/dojo/dojo-58.png" /></center>

<p>Isso encerra esta task.</p>

<h2 id="task-x19">Task \x19</h2>

<center><img src="/img/std/dojo/dojo-59.png" /></center>

<p>Esta task é a mais complexa desta semana do Dojo, precisamos montar uma ferramenta de <code class="language-plaintext highlighter-rouge">discover</code> de rede.</p>

<p>Basicamente, vamos utilizar o script anterior para encontrar o IP e a máscara de rede, com estes dados, precisamos calcular todo o range de IP desta subrede, para isto utilizei a função <code class="language-plaintext highlighter-rouge">IPNetwork()</code> da biblioteca <code class="language-plaintext highlighter-rouge">netaddr</code>.</p>

<p>Esta função recebe o IP + a máscara de subrede (Ex.: <code class="language-plaintext highlighter-rouge">192.168.1.7/24</code>) e calcula todo o range possível de IPs dentro desta subrede. A partir daí, vasculha todos os hosts ativos dentro da rede privada, quando encontra um host vivo, começa o scan de portas conforme já fizemos anteriormente.</p>

<p>Neste script, utilizamos basicamente tudo que foi aprendido nesta semana em uma única ferramente, além de adicionar algo mais, como a <code class="language-plaintext highlighter-rouge">classe</code> com as cores para o terminal, atendendo os requisitos solicitados.</p>

<p>O script ficou desta forma:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">ipaddress</span> <span class="kn">import</span> <span class="n">ip_address</span>
<span class="kn">from</span> <span class="nn">netaddr</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">icmplib</span> <span class="kn">import</span> <span class="n">ping</span>
<span class="kn">import</span> <span class="nn">netifaces</span>
<span class="kn">import</span> <span class="nn">socket</span>

<span class="n">lista</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">class</span> <span class="nc">cor</span><span class="p">:</span>
        <span class="n">normal</span> <span class="o">=</span> <span class="s">'</span><span class="se">\033</span><span class="s">[0m'</span>
        <span class="n">azul</span> <span class="o">=</span> <span class="s">'</span><span class="se">\033</span><span class="s">[94m'</span>
        <span class="n">verm</span> <span class="o">=</span> <span class="s">'</span><span class="se">\033</span><span class="s">[91m'</span>
        <span class="n">verde</span> <span class="o">=</span> <span class="s">'</span><span class="se">\033</span><span class="s">[92m'</span>

<span class="n">dic_msk</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"255.128.0.0"</span><span class="p">:</span> <span class="s">"/9"</span><span class="p">,</span>
        <span class="s">"255.192.0.0"</span><span class="p">:</span> <span class="s">"/10"</span><span class="p">,</span>
        <span class="s">"255.224.0.0"</span><span class="p">:</span> <span class="s">"/11"</span><span class="p">,</span>
        <span class="s">"255.240.0.0"</span><span class="p">:</span> <span class="s">"/12"</span><span class="p">,</span>
        <span class="s">"255.248.0.0"</span><span class="p">:</span> <span class="s">"/13"</span><span class="p">,</span>
        <span class="s">"255.252.0.0"</span><span class="p">:</span> <span class="s">"/14"</span><span class="p">,</span>
        <span class="s">"255.254.0.0"</span><span class="p">:</span> <span class="s">"/15"</span><span class="p">,</span>
        <span class="s">"255.255.0.0"</span><span class="p">:</span> <span class="s">"/16"</span><span class="p">,</span>
        <span class="s">"255.255.128.0"</span><span class="p">:</span> <span class="s">"/17"</span><span class="p">,</span>
        <span class="s">"255.255.192.0"</span><span class="p">:</span> <span class="s">"/18"</span><span class="p">,</span>
        <span class="s">"255.255.224.0"</span><span class="p">:</span> <span class="s">"/19"</span><span class="p">,</span>
        <span class="s">"255.255.240.0"</span><span class="p">:</span> <span class="s">"/20"</span><span class="p">,</span>
        <span class="s">"255.255.248.0"</span><span class="p">:</span> <span class="s">"/21"</span><span class="p">,</span>
        <span class="s">"255.255.252.0"</span><span class="p">:</span> <span class="s">"/22"</span><span class="p">,</span>
        <span class="s">"255.255.254.0"</span><span class="p">:</span> <span class="s">"/23"</span><span class="p">,</span>
        <span class="s">"255.255.255.0"</span><span class="p">:</span> <span class="s">"/24"</span><span class="p">,</span>
        <span class="s">"255.255.255.128"</span><span class="p">:</span> <span class="s">"/25"</span><span class="p">,</span>
        <span class="s">"255.255.255.192"</span><span class="p">:</span> <span class="s">"/26"</span><span class="p">,</span>
        <span class="s">"255.255.255.224"</span><span class="p">:</span> <span class="s">"/27"</span><span class="p">,</span>
        <span class="s">"255.255.255.240"</span><span class="p">:</span> <span class="s">"/28"</span><span class="p">,</span>
        <span class="s">"255.255.255.248"</span><span class="p">:</span> <span class="s">"/29"</span><span class="p">,</span>
        <span class="s">"255.255.255.252"</span><span class="p">:</span> <span class="s">"/30"</span><span class="p">,</span>
        <span class="s">"255.255.255.254"</span><span class="p">:</span> <span class="s">"/31"</span>
        <span class="p">}</span>

<span class="k">def</span> <span class="nf">port_scan</span><span class="p">(</span><span class="n">host</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">65536</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">connect_ex</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
        <span class="n">s</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">resp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">cor</span><span class="p">.</span><span class="n">verde</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">cor</span><span class="p">.</span><span class="n">verm</span> <span class="o">+</span> <span class="s">" --- "</span> <span class="o">+</span> <span class="n">cor</span><span class="p">.</span><span class="n">azul</span> <span class="o">+</span> <span class="s">"ABERTA"</span> <span class="o">+</span> <span class="n">cor</span><span class="p">.</span><span class="n">normal</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">icmp</span><span class="p">(</span><span class="n">host</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">ping</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">packets_received</span>
    <span class="k">if</span> <span class="n">resp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">["</span> <span class="o">+</span> <span class="n">cor</span><span class="p">.</span><span class="n">verde</span> <span class="o">+</span> <span class="s">"-"</span> <span class="o">+</span> <span class="n">cor</span><span class="p">.</span><span class="n">normal</span> <span class="o">+</span> <span class="s">"] "</span> <span class="o">+</span> <span class="n">host</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="n">port_scan</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">self_ip</span><span class="p">():</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
    <span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="s">"8.8.8.8"</span><span class="p">,</span> <span class="mi">80</span><span class="p">))</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">s</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">resp</span>

<span class="k">def</span> <span class="nf">mask</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">netifaces</span><span class="p">.</span><span class="n">interfaces</span><span class="p">():</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">netifaces</span><span class="p">.</span><span class="n">ifaddresses</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rede</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">addr</span> <span class="o">=</span> <span class="n">rede</span><span class="p">[</span><span class="s">"addr"</span><span class="p">]</span>
            <span class="n">msk</span> <span class="o">=</span> <span class="n">rede</span><span class="p">[</span><span class="s">"netmask"</span><span class="p">]</span>
            <span class="n">host</span> <span class="o">=</span> <span class="n">self_ip</span><span class="p">()</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">dic_msk</span><span class="p">[</span><span class="n">msk</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">addr</span> <span class="o">==</span> <span class="n">host</span><span class="p">:</span>
                <span class="n">host</span> <span class="o">+=</span> <span class="n">mask</span>
                <span class="k">return</span> <span class="n">host</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">continue</span>

<span class="k">def</span> <span class="nf">hosts</span><span class="p">():</span>
    <span class="n">sub</span> <span class="o">=</span> <span class="n">mask</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Rede:"</span><span class="p">,</span> <span class="n">sub</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
    <span class="n">sub</span> <span class="o">=</span> <span class="n">IPNetwork</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">icmp</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">hosts</span><span class="p">()</span>
</code></pre></div></div>
<p>A execução deste script pode <code class="language-plaintext highlighter-rouge">demorar</code> de acordo com a quantidade de hosts vivos na rede, sua resposta fica desta forma:</p>

<center><img src="/img/std/dojo/dojo-60.png" /></center>

<p>Este script ainda pode ser melhorado com a implementação do <code class="language-plaintext highlighter-rouge">top ports</code> e/ou <code class="language-plaintext highlighter-rouge">portas específicas</code> visando a melhor performance e acertabilidade.</p>

<p>Desta forma finalizamos as tasks da semana 03, em breve continuaremos na trilha.</p>

<p>Bons estudos!</p>
